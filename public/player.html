<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - Alpha Channel Media</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f0ede8;
            --bg-glossy: linear-gradient(135deg, #f5f2ed 0%, #faf8f5 20%, #f0ede8 40%, #fdf5f5 60%, #f0f7f3 80%, #f5f2ed 100%);
            --surface: rgba(255,255,255,0.55);
            --surface-solid: #ffffff;
            --green: #006e45; --green-glow: rgba(0,110,69,0.25); --red: #b82e2e; --red-glow: rgba(184,46,46,0.2);
            --text: #111111; --text-secondary: #555555; --border: rgba(0,0,0,0.08);
            --panel-glow: 0 0 30px rgba(0,110,69,0.12), 0 0 60px rgba(184,46,46,0.08);
            --panel-border: rgba(0,0,0,0.06); --input-bg: rgba(255,255,255,0.7);
            --track-hover: rgba(0,110,69,0.06);
            --shimmer-color: rgba(0,110,69,0.15);
            /* Adaptive colors (updated by JS) */
            --art-primary: 0,110,69;
            --art-secondary: 184,46,46;
        }
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-glossy: linear-gradient(135deg, #0e0e0e 0%, #121210 20%, #0e100e 40%, #140e0e 60%, #0e1210 80%, #0e0e0e 100%);
            --surface: rgba(25,25,25,0.7);
            --surface-solid: #141414;
            --green: #00c97a; --green-glow: rgba(0,201,122,0.2); --red: #e04545; --red-glow: rgba(224,69,69,0.15);
            --text: #eaeaea; --text-secondary: #999999; --border: rgba(255,255,255,0.08);
            --panel-glow: 0 0 40px rgba(0,201,122,0.1), 0 0 80px rgba(224,69,69,0.06);
            --panel-border: rgba(255,255,255,0.06); --input-bg: rgba(40,40,40,0.7);
            --track-hover: rgba(0,201,122,0.06);
            --shimmer-color: rgba(0,201,122,0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-glossy);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        /* Glossy orbs */
        body::before, body::after {
            content: ''; position: fixed; border-radius: 50%;
            filter: blur(80px); opacity: 0.4; pointer-events: none; z-index: 0;
        }
        body::before {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(0,150,80,0.2), transparent 70%);
            top: -100px; right: -100px;
        }
        body::after {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(200,40,40,0.15), transparent 70%);
            bottom: -50px; left: -50px;
        }

        /* Adaptive color overlay — driven by artwork */
        .adaptive-bg {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            transition: opacity 1.5s ease;
            opacity: 0;
        }
        .adaptive-bg.active { opacity: 1; }

        /* Shimmer text */
        .shimmer-text {
            background: linear-gradient(120deg, var(--text) 0%, var(--text) 40%, var(--shimmer-color) 50%, var(--text) 60%, var(--text) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }

        .back-arrow {
            position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            backdrop-filter: blur(10px); text-decoration: none; transition: all 0.3s;
        }
        .back-arrow:hover { box-shadow: var(--panel-glow); }
        .back-arrow svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .logout-link { color: var(--red) !important; }
        .settings-link { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .settings-link:hover { color: var(--green); }

        /* Browse / Discovery View */
        .browse-view {
            position: relative; z-index: 1;
            min-height: 100vh; padding: 0 0 160px 0;
        }
        .browse-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
        }
        [data-theme="dark"] .browse-header { background: rgba(10,10,10,0.85); }
        .browse-header-left { display: flex; align-items: center; gap: 12px; }
        .browse-header-left h1 { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .browse-header-right { display: flex; align-items: center; gap: 16px; }
        .browse-header-right a { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .browse-header-right a:hover { color: var(--green); }

        .search-container {
            max-width: 600px; margin: 24px auto 0; padding: 0 20px;
        }
        .search-box {
            display: flex; align-items: center; gap: 10px;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 12px 16px;
            backdrop-filter: blur(15px); transition: all 0.3s;
        }
        .search-box:focus-within { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
        .search-box svg { width: 20px; height: 20px; fill: var(--text-secondary); flex-shrink: 0; }
        .search-box input {
            flex: 1; border: none; background: transparent; font-size: 1rem;
            color: var(--text); font-family: 'Inter', sans-serif; outline: none;
        }
        .search-box input::placeholder { color: var(--text-secondary); opacity: 0.6; }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem; font-weight: 700; color: var(--text);
            padding: 32px 20px 16px; max-width: 900px; margin: 0 auto;
        }

        /* Creator Cards Grid */
        .creators-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px; max-width: 900px; margin: 0 auto; padding: 0 20px;
        }
        .creator-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px 16px; text-align: center;
            cursor: pointer; transition: all 0.25s; backdrop-filter: blur(15px);
        }
        .creator-card:hover { transform: translateY(-4px); box-shadow: var(--panel-glow); border-color: var(--green); }
        .creator-card-photo {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; font-size: 2rem; font-weight: 700; color: var(--green);
        }
        .creator-card-photo img { width: 100%; height: 100%; object-fit: cover; }
        .creator-card h4 { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .creator-card p { font-size: 0.8rem; color: var(--text-secondary); }

        /* Creator Profile View */
        .profile-view { display: none; max-width: 900px; margin: 0 auto; padding: 0 20px 24px; }
        .profile-view.active { display: block; }
        .profile-back {
            display: inline-flex; align-items: center; gap: 6px; padding: 10px 0;
            color: var(--text-secondary); font-size: 0.9rem; cursor: pointer;
            background: none; border: none; font-family: 'Inter', sans-serif;
        }
        .profile-back:hover { color: var(--green); }
        .profile-back svg { width: 18px; height: 18px; fill: currentColor; }
        .profile-header {
            display: flex; align-items: center; gap: 24px; padding: 16px 0 24px;
        }
        .profile-photo {
            width: 120px; height: 120px; border-radius: 50%; flex-shrink: 0;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; font-size: 3rem; font-weight: 700; color: var(--green);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info { flex: 1; min-width: 0; }
        .profile-info h2 { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .profile-info .profile-bio { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4; }
        .profile-info .profile-stats { font-size: 0.85rem; color: var(--text-secondary); }
        .subscribe-btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 24px;
            border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; border: 2px solid var(--green);
            margin-top: 8px;
        }
        .subscribe-btn.subscribed { background: transparent; color: var(--green); }
        .subscribe-btn:not(.subscribed) { background: var(--green); color: white; }
        .subscribe-btn:hover { opacity: 0.85; transform: scale(1.02); }

        /* Search Results */
        .search-results { max-width: 900px; margin: 0 auto; padding: 0 20px; display: none; }
        .search-results.active { display: block; }
        .search-result-song {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            border-radius: 10px; cursor: pointer; transition: background 0.15s;
        }
        .search-result-song:hover { background: var(--track-hover); }
        .search-result-song .sr-art {
            width: 44px; height: 44px; border-radius: 8px; flex-shrink: 0;
            background: var(--green-glow); display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .search-result-song .sr-art img { width: 100%; height: 100%; object-fit: cover; }
        .search-result-song .sr-info { min-width: 0; }
        .search-result-song .sr-info h4 { font-size: 0.95rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-result-song .sr-info p { font-size: 0.8rem; color: var(--text-secondary); }

        /* Main player layout */
        .player-app { display: none; min-height: 100vh; padding-bottom: 160px; position: relative; z-index: 1; }
        .player-app.active { display: block; }

        /* Header bar */
        .player-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(var(--art-primary), 0.05);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            transition: background 1s ease;
        }
        .player-header-left { display: flex; align-items: center; gap: 12px; margin-left: 40px; }
        .player-header-left h1 { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .player-header-right { display: flex; align-items: center; gap: 16px; }
        .player-header-right a { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .player-header-right a:hover { color: var(--green); }

        /* Hero artwork section — large, immersive */
        .hero-section {
            position: relative;
            padding: 48px 20px 36px;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }
        .hero-inner {
            max-width: 900px; width: 100%;
            display: flex; align-items: flex-end; gap: 36px;
        }
        .hero-art {
            width: 320px; height: 320px; border-radius: 20px;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; flex-shrink: 0;
            box-shadow: 0 16px 60px rgba(0,0,0,0.25);
            transition: box-shadow 1s ease;
        }
        .hero-art img { width: 100%; height: 100%; object-fit: cover; }
        .hero-art svg { width: 80px; height: 80px; fill: var(--text-secondary); opacity: 0.3; }
        .hero-info { flex: 1; padding-bottom: 8px; }
        .hero-type { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; }
        .hero-title { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .hero-artist { font-size: 1rem; color: var(--green); font-weight: 500; margin-bottom: 12px; }
        .hero-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .play-all-btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 14px 32px;
            background: var(--green); color: white; border: none; border-radius: 24px;
            font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: all 0.2s;
        }
        .play-all-btn:hover { opacity: 0.85; transform: scale(1.02); }
        .play-all-btn svg { width: 20px; height: 20px; fill: white; }
        .change-key-link { display: none; }

        /* Track list */
        .track-list-container { max-width: 900px; margin: 0 auto; padding: 0 20px 24px; }

        /* Track rows */
        .track-table { width: 100%; }
        .track-table-header {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 8px 12px; border-bottom: 1px solid var(--border);
            color: var(--text-secondary); font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .track-row {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 10px 12px; border-radius: 10px; cursor: pointer;
            align-items: center; transition: background 0.15s;
        }
        .track-row:hover { background: var(--track-hover); }
        .track-row.active { background: rgba(var(--art-primary), 0.12); }
        .track-row .tr-num { text-align: center; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .track-row.active .tr-num { color: var(--green); }
        .track-row .tr-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .track-row .tr-art img { width: 100%; height: 100%; object-fit: cover; }
        .track-row .tr-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .track-row .tr-info { min-width: 0; }
        .track-row .tr-info h4 {
            font-size: 0.95rem; font-weight: 500; color: var(--text); margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-row.active .tr-info h4 { color: var(--green); }
        .track-row .tr-info p { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-row .tr-duration { font-size: 0.85rem; color: var(--text-secondary); text-align: right; }

        /* Now Playing Bar (fixed bottom) */
        .now-playing-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
            background: var(--surface-solid); border-top: 1px solid var(--border);
            backdrop-filter: blur(25px); display: none;
        }
        .now-playing-bar.active { display: block; }
        .npb-progress {
            width: 100%; height: 3px; background: var(--border); cursor: pointer; position: relative;
        }
        .npb-progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.15s linear; }
        .npb-content {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px;
            padding: 10px 20px; padding-bottom: max(10px, env(safe-area-inset-bottom));
            align-items: center; max-width: 1200px; margin: 0 auto;
        }
        .npb-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
        .npb-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
        }
        .npb-art img { width: 100%; height: 100%; object-fit: cover; }
        .npb-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .npb-track-info { min-width: 0; }
        .npb-track-info h4 { font-size: 0.9rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-track-info p { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-center { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .npb-controls { display: flex; align-items: center; gap: 20px; }
        .npb-btn {
            background: none; border: none; cursor: pointer; padding: 6px; display: flex;
            align-items: center; justify-content: center; transition: transform 0.15s;
        }
        .npb-btn:hover { transform: scale(1.1); }
        .npb-btn:active { transform: scale(0.95); }
        .npb-btn svg { fill: var(--text); }
        .npb-btn.npb-play {
            width: 40px; height: 40px; background: var(--green); border-radius: 50%;
        }
        .npb-btn.npb-play svg { fill: white; width: 18px; height: 18px; }
        .npb-btn.active-mode svg { fill: var(--green); }
        .npb-times { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-secondary); }
        .npb-time-bar { width: 100%; max-width: 400px; height: 4px; background: var(--border); border-radius: 2px; cursor: pointer; position: relative; }
        .npb-time-fill { height: 100%; background: var(--green); border-radius: 2px; width: 0%; position: relative; }
        .npb-time-fill::after {
            content: ''; position: absolute; right: -5px; top: -3px; width: 10px; height: 10px;
            background: var(--green); border-radius: 50%; opacity: 0; transition: opacity 0.15s;
        }
        .npb-time-bar:hover .npb-time-fill::after { opacity: 1; }
        .npb-right { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .npb-vol-slider {
            position: relative; width: 100px; height: 20px; cursor: pointer;
            display: flex; align-items: center;
        }
        .npb-vol-track {
            position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
            height: 3px; background: var(--border); border-radius: 2px;
        }
        .npb-vol-fill {
            height: 100%; background: var(--green); border-radius: 2px; width: 80%;
            transition: width 0.05s linear;
        }
        .npb-vol-dot {
            position: absolute; top: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--green); left: 80%;
            box-shadow: 0 0 6px rgba(0,0,0,0.15);
            transition: width 0.2s ease, height 0.2s ease, box-shadow 0.2s ease;
            pointer-events: none;
        }
        .npb-vol-slider.dragging .npb-vol-dot,
        .npb-vol-slider:hover .npb-vol-dot {
            width: 16px; height: 16px;
            box-shadow: 0 0 12px var(--green-glow);
        }
        .npb-vol-icon { width: 18px; height: 18px; fill: var(--text-secondary); cursor: pointer; }

        /* No longer using creator selector overlay */

        /* Empty state */
        .empty-tracks { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-tracks svg { width: 64px; height: 64px; fill: var(--text-secondary); opacity: 0.2; margin-bottom: 16px; }

        /* Responsive */
        @media (max-width: 768px) {
            .creators-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
            .profile-header { flex-direction: column; text-align: center; gap: 16px; }
            .profile-photo { width: 100px; height: 100px; }
            .profile-info h2 { font-size: 1.5rem; }
            .browse-header-right .nav-link { display: none; }
            .player-header-left { margin-left: 48px; }
            .player-header-right .nav-link { display: none; }
            .hero-inner { flex-direction: column; align-items: center; text-align: center; gap: 24px; }
            .hero-art { width: 280px; height: 280px; }
            .hero-title { font-size: 1.8rem; }
            .track-table-header { display: none; }
            .track-row { grid-template-columns: 40px 48px 1fr; }
            .track-row .tr-duration { display: none; }
            .track-row .tr-art { width: 48px; height: 48px; }
            .npb-content { grid-template-columns: 1fr auto; grid-template-rows: auto auto; }
            .npb-right { display: flex; grid-column: 1 / -1; justify-content: center; padding-top: 4px; }
            .npb-vol-slider { width: 140px; }
            .npb-center { gap: 4px; }
            .npb-times { display: none; }
            .player-app { padding-bottom: 180px; }
        }
        @media (max-width: 480px) {
            .player-header-left h1 { font-size: 1rem; }
            .hero-section { padding: 32px 16px 24px; }
            .hero-art { width: 240px; height: 240px; border-radius: 16px; }
            .hero-title { font-size: 1.5rem; }
            .track-row { padding: 8px; gap: 10px; grid-template-columns: 32px 44px 1fr; }
            .track-row .tr-art { width: 44px; height: 44px; }
            .track-row .tr-info h4 { font-size: 0.9rem; }
            .npb-art { width: 40px; height: 40px; }
            .npb-controls { gap: 16px; }
            .npb-btn.npb-play { width: 36px; height: 36px; }
            .npb-vol-slider { width: 120px; }
        }
        /* ===== FULL-SCREEN PLAYER ===== */
        .fs-player-overlay {
            position: fixed; inset: 0; z-index: 300;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.35s ease;
        }
        .fs-player-overlay.active { opacity: 1; pointer-events: all; }
        .fs-player-bg {
            position: absolute; inset: 0;
            background: var(--surface-solid, var(--surface));
            opacity: 0.97;
        }
        .fs-player-content {
            position: relative; z-index: 1;
            width: 100%; max-width: 480px;
            padding: 40px 32px;
            display: flex; flex-direction: column;
            align-items: center; gap: 20px;
            max-height: 100vh; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .fs-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: all 0.2s;
        }
        .fs-close-btn:hover { box-shadow: var(--panel-glow); }
        .fs-close-btn svg { fill: var(--text-secondary); }
        .fs-art {
            width: 300px; height: 300px; border-radius: 20px;
            background: linear-gradient(135deg, var(--green-glow, rgba(0,110,69,0.2)), var(--red-glow, rgba(211,47,47,0.2)));
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; flex-shrink: 0;
            box-shadow: 0 16px 60px rgba(0,0,0,0.25);
            transition: box-shadow 1s ease;
        }
        .fs-art img { width: 100%; height: 100%; object-fit: cover; }
        .fs-art svg { width: 80px; height: 80px; fill: var(--text-secondary); opacity: 0.3; }
        .fs-track-info { text-align: center; width: 100%; }
        .fs-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem; font-weight: 700; color: var(--text);
            margin-bottom: 4px;
        }
        .fs-artist { font-size: 1rem; color: var(--green); font-weight: 500; margin: 0; }
        .fs-credits {
            width: 100%; display: none;
            padding: 16px; border-radius: 12px;
            background: var(--surface); border: 1px solid var(--border);
        }
        .fs-credits.has-credits { display: block; }
        .fs-credits h5 {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-secondary); margin: 0 0 10px 0;
        }
        .fs-credit-row {
            display: flex; justify-content: space-between;
            padding: 4px 0; font-size: 0.85rem;
        }
        .fs-credit-role { color: var(--text-secondary); }
        .fs-credit-name { color: var(--text); font-weight: 500; }
        .fs-progress { width: 100%; }
        .fs-time-bar {
            width: 100%; height: 6px; background: var(--border);
            border-radius: 3px; cursor: pointer; position: relative;
        }
        .fs-time-fill {
            height: 100%; background: var(--green); border-radius: 3px;
            width: 0%; position: relative; transition: width 0.1s linear;
        }
        .fs-time-fill::after {
            content: ''; position: absolute; right: -6px; top: -5px;
            width: 16px; height: 16px; background: var(--green);
            border-radius: 50%; opacity: 0; transition: opacity 0.15s;
        }
        .fs-time-bar:hover .fs-time-fill::after { opacity: 1; }
        .fs-times {
            display: flex; justify-content: space-between;
            font-size: 0.8rem; color: var(--text-secondary); margin-top: 6px;
        }
        .fs-controls { display: flex; align-items: center; gap: 24px; }
        .fs-ctrl-btn {
            background: none; border: none; cursor: pointer; padding: 8px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.15s;
        }
        .fs-ctrl-btn:hover { transform: scale(1.1); }
        .fs-ctrl-btn:active { transform: scale(0.95); }
        .fs-ctrl-btn svg { fill: var(--text); }
        .fs-ctrl-btn.active-mode svg { fill: var(--green); }
        .fs-ctrl-btn.fs-play {
            width: 64px; height: 64px; background: var(--green); border-radius: 50%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .fs-ctrl-btn.fs-play svg { fill: white; width: 28px; height: 28px; }
        .fs-volume {
            display: flex; align-items: center; gap: 10px; width: 100%;
            justify-content: center;
        }
        .fs-vol-icon { width: 20px; height: 20px; fill: var(--text-secondary); cursor: pointer; }
        .fs-vol-slider {
            position: relative; width: 160px; height: 20px; cursor: pointer;
            display: flex; align-items: center;
        }
        .fs-vol-track {
            position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
            height: 4px; background: var(--border); border-radius: 2px;
        }
        .fs-vol-fill {
            height: 100%; background: var(--green); border-radius: 2px;
            width: 80%; transition: width 0.05s linear;
        }
        .fs-vol-dot {
            position: absolute; top: 50%; transform: translate(-50%, -50%);
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--green); left: 80%;
            box-shadow: 0 0 6px rgba(0,0,0,0.15); pointer-events: none;
        }
        .npb-left { cursor: pointer; }
        @media (max-width: 480px) {
            .fs-player-content { padding: 32px 20px; }
            .fs-art { width: 260px; height: 260px; border-radius: 16px; }
            .fs-title { font-size: 1.3rem; }
            .fs-controls { gap: 18px; }
            .fs-ctrl-btn.fs-play { width: 56px; height: 56px; }
        }
        /* ===== SETTINGS OVERLAY ===== */
        .settings-overlay {
            position: fixed; inset: 0; z-index: 250;
            display: flex; align-items: flex-start; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 40px 20px 40px;
        }
        .settings-overlay.active { opacity: 1; pointer-events: all; }
        .settings-overlay-bg {
            position: fixed; inset: 0;
            background: var(--surface-solid); opacity: 0.97;
        }
        .settings-overlay-content {
            position: relative; z-index: 1;
            width: 100%; max-width: 560px;
            background: var(--surface); backdrop-filter: blur(25px);
            border-radius: 24px; border: 1px solid var(--panel-border);
            box-shadow: var(--panel-glow);
            padding: 48px 40px; margin-top: 20px;
        }
        .settings-close-btn {
            position: absolute; top: 16px; right: 16px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: all 0.2s; font-size: 1.2rem; color: var(--text-secondary);
        }
        .settings-close-btn:hover { box-shadow: var(--panel-glow); color: var(--text); }
        .settings-header { text-align: center; margin-bottom: 36px; }
        .settings-header h1 {
            font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700;
            color: var(--text); margin-bottom: 8px;
        }
        .settings-header p { color: var(--text-secondary); font-size: 0.95rem; }
        /* Settings form styles */
        .stg-section-title {
            font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-secondary); margin-bottom: 14px;
        }
        .stg-profile-field { margin-bottom: 16px; }
        .stg-profile-field label {
            display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .stg-profile-field input {
            width: 100%; padding: 12px 14px; background: var(--input-bg); border: 1px solid var(--border);
            border-radius: 10px; font-size: 0.95rem; color: var(--text); font-family: 'Inter', sans-serif;
            transition: border-color 0.2s; outline: none; box-sizing: border-box;
        }
        .stg-profile-field input:focus { border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
        .stg-profile-field input[readonly] { opacity: 0.6; cursor: not-allowed; }
        .stg-profile-field .field-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }
        .stg-profile-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        @media (max-width: 480px) { .stg-profile-row { grid-template-columns: 1fr; } }
        .stg-save-btn {
            width: 100%; padding: 14px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer;
            margin-top: 8px; transition: all 0.3s; font-family: 'Inter', sans-serif;
        }
        .stg-save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .stg-save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .stg-section-divider { border: none; border-top: 1px solid var(--border); margin: 28px 0; }
        .stg-pw-toggle-btn {
            display: inline-block; padding: 10px 20px; background: transparent; border: 1px solid var(--border);
            border-radius: 10px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif;
        }
        .stg-pw-toggle-btn:hover { border-color: var(--green); color: var(--green); }
        .stg-pw-fields { display: none; margin-top: 16px; }
        .stg-pw-fields.visible { display: block; }
        .stg-status-msg { text-align: center; margin-top: 12px; font-size: 0.9rem; display: none; }
        .stg-status-msg.success { color: var(--green); display: block; }
        .stg-status-msg.error { color: var(--red); display: block; }
        /* Theme selector */
        .stg-theme-selector { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }
        .stg-theme-option {
            display: flex; align-items: center; padding: 16px;
            background: var(--input-bg); border-radius: 12px;
            border: 2px solid var(--border); cursor: pointer; transition: all 0.2s;
        }
        .stg-theme-option:has(input:checked) { border-color: var(--green); }
        [data-theme="light"] .stg-theme-option:has(input:checked) { background: rgba(0,110,69,0.05); }
        [data-theme="dark"] .stg-theme-option:has(input:checked) { background: rgba(0,201,122,0.08); }
        .stg-theme-option input { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--green); cursor: pointer; }
        .stg-theme-option-label { font-weight: 600; font-size: 0.95rem; color: var(--text); margin-bottom: 2px; }
        .stg-theme-option-desc { font-size: 0.8rem; color: var(--text-secondary); }
        /* Global toggle */
        .stg-global-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px; background: var(--input-bg); border-radius: 14px;
            border: 1px solid var(--border); margin-bottom: 28px;
        }
        .stg-global-toggle h3 { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .stg-global-toggle p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .stg-toggle-switch { position: relative; width: 50px; height: 28px; flex-shrink: 0; }
        .stg-toggle-switch input { opacity: 0; width: 0; height: 0; }
        .stg-toggle-slider {
            position: absolute; cursor: pointer; inset: 0; background: var(--border);
            border-radius: 28px; transition: 0.3s;
        }
        .stg-toggle-slider::before {
            content: ''; position: absolute; width: 22px; height: 22px; left: 3px; bottom: 3px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        .stg-toggle-switch input:checked + .stg-toggle-slider { background: var(--green); }
        .stg-toggle-switch input:checked + .stg-toggle-slider::before { transform: translateX(22px); }
        /* Creator subscriptions */
        .stg-creator-sub {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; background: var(--input-bg); border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 10px;
        }
        .stg-creator-sub-info { display: flex; align-items: center; gap: 12px; }
        .stg-creator-sub-icon {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .stg-creator-sub-icon svg { width: 20px; height: 20px; fill: var(--green); }
        .stg-creator-sub-name { font-weight: 600; font-size: 0.95rem; color: var(--text); }
        .stg-creator-sub-detail { font-size: 0.8rem; color: var(--text-secondary); }
        .stg-no-subs {
            text-align: center; padding: 24px; color: var(--text-secondary);
            font-size: 0.9rem; background: var(--input-bg); border-radius: 12px;
            border: 1px solid var(--border);
        }
        .stg-pref-save-btn {
            width: 100%; padding: 16px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-size: 1.05rem; font-weight: 600; cursor: pointer;
            margin-top: 24px; transition: all 0.3s; font-family: 'Inter', sans-serif;
        }
        .stg-pref-save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .stg-pref-save-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        @media (max-width: 768px) {
            .settings-overlay-content { padding: 36px 28px; margin-top: 10px; }
            .settings-header h1 { font-size: 1.6rem; }
        }
        @media (max-width: 480px) {
            .settings-overlay-content { padding: 28px 18px; border-radius: 20px; }
            .settings-header h1 { font-size: 1.4rem; }
            .settings-overlay { padding: 20px 12px 20px; }
        }
    </style>
</head>
<body>
    <!-- Adaptive color background overlay -->
    <div class="adaptive-bg" id="adaptiveBg"></div>

    <!-- BROWSE VIEW (Top Creators + Search — default landing) -->
    <div class="browse-view" id="browseView">
        <div class="browse-header">
            <div class="browse-header-left">
                <h1 class="shimmer-text">Alpha Channel Media</h1>
            </div>
            <div class="browse-header-right">
                <a href="videos.html" class="nav-link">Videos</a>
                <a href="#" onclick="openSettings(); return false;" class="settings-link">Settings</a>
                <a href="#" onclick="logout(); return false;" class="logout-link">Logout</a>
            </div>
        </div>

        <div class="search-container">
            <div class="search-box">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" placeholder="Search creators or songs..." autocomplete="off">
            </div>
        </div>

        <!-- Search Results (hidden by default) -->
        <div class="search-results" id="searchResults"></div>

        <!-- Top Creators Grid -->
        <div id="topCreatorsSection">
            <h2 class="section-title">Top Creators</h2>
            <div class="creators-grid" id="topCreatorsGrid"></div>
        </div>

        <!-- Creator Profile View (hidden by default) -->
        <div class="profile-view" id="profileView">
            <button class="profile-back" onclick="showBrowse()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back to Creators
            </button>
            <div class="profile-header">
                <div class="profile-photo" id="profilePhoto"></div>
                <div class="profile-info">
                    <h2 id="profileName"></h2>
                    <div class="profile-bio" id="profileBio"></div>
                    <div class="profile-stats" id="profileStats"></div>
                    <button class="subscribe-btn" id="subscribeBtn" onclick="toggleSubscribe()">Subscribe</button>
                </div>
            </div>
            <h3 class="section-title" style="padding-left:0;">Songs</h3>
            <div class="track-table">
                <div class="track-table-header">
                    <span>#</span>
                    <span></span>
                    <span>Title</span>
                    <span style="text-align:right;">Duration</span>
                </div>
                <div id="profileTracksList"></div>
            </div>
        </div>
    </div>

    <!-- PLAYER APP (used when playing a specific creator's songs — now also works as song list backdrop) -->
    <div class="player-app" id="playerApp" style="display:none;">
        <div class="player-header">
            <div class="player-header-left">
                <h1 id="headerTitle" class="shimmer-text">Alpha Channel Media</h1>
            </div>
            <div class="player-header-right">
                <a href="videos.html" class="nav-link">Videos</a>
                <a href="#" onclick="openSettings(); return false;" class="settings-link">Settings</a>
                <a href="#" onclick="logout(); return false;" class="logout-link">Logout</a>
            </div>
        </div>

        <!-- Hero: large artwork + info -->
        <div class="hero-section">
            <div class="hero-inner">
                <div class="hero-art" id="heroArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="hero-info">
                    <div class="hero-type">Playlist</div>
                    <div class="hero-title shimmer-text" id="libraryTitle">Music Library</div>
                    <div class="hero-artist" id="libraryArtist"></div>
                    <div class="hero-meta" id="libraryMeta"></div>
                    <button class="play-all-btn" onclick="playAll()">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Play All
                    </button>
                </div>
            </div>
        </div>

        <div class="track-list-container">
            <div class="track-table">
                <div class="track-table-header">
                    <span>#</span>
                    <span></span>
                    <span>Title</span>
                    <span style="text-align:right;">Duration</span>
                </div>
                <div id="tracksList"></div>
            </div>
        </div>
    </div>

    <!-- NOW PLAYING BAR -->
    <div class="now-playing-bar" id="nowPlayingBar">
        <div class="npb-progress" id="npbProgressTop" onclick="seekFromBar(event, this)">
            <div class="npb-progress-fill" id="npbProgressTopFill"></div>
        </div>
        <div class="npb-content">
            <div class="npb-left">
                <div class="npb-art" id="npbArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="npb-track-info">
                    <h4 id="npbTitle">-</h4>
                    <p id="npbArtist">-</p>
                </div>
            </div>
            <div class="npb-center">
                <div class="npb-controls">
                    <button class="npb-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="prevTrack()" title="Previous">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button class="npb-btn npb-play" onclick="togglePlay()" id="mainPlayBtn" title="Play">
                        <svg viewBox="0 0 24 24" id="mainPlayIcon"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="nextTrack()" title="Next">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="toggleRepeat()" id="repeatBtn" title="Repeat">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    </button>
                </div>
                <div class="npb-times">
                    <span id="npbCurrentTime">0:00</span>
                    <div class="npb-time-bar" onclick="seekFromBar(event, this)">
                        <div class="npb-time-fill" id="npbTimeFill"></div>
                    </div>
                    <span id="npbDuration">0:00</span>
                </div>
            </div>
            <div class="npb-right">
                <svg class="npb-vol-icon" viewBox="0 0 24 24" onclick="toggleMute()"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <div class="npb-vol-slider" id="volSlider">
                    <div class="npb-vol-track"><div class="npb-vol-fill" id="volFill"></div></div>
                    <div class="npb-vol-dot" id="volDot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL-SCREEN PLAYER OVERLAY -->
    <div class="fs-player-overlay" id="fsPlayer">
        <div class="fs-player-bg" id="fsBg"></div>
        <div class="fs-player-content">
            <button class="fs-close-btn" id="fsCloseBtn" title="Close">
                <svg width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
            <div class="fs-art" id="fsArt">
                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <div class="fs-track-info">
                <h2 class="fs-title" id="fsTitle">-</h2>
                <p class="fs-artist" id="fsArtist">-</p>
            </div>
            <div class="fs-credits" id="fsCredits"></div>
            <div class="fs-progress">
                <div class="fs-time-bar" id="fsTimeBar">
                    <div class="fs-time-fill" id="fsTimeFill"></div>
                </div>
                <div class="fs-times">
                    <span id="fsCurrentTime">0:00</span>
                    <span id="fsDuration">0:00</span>
                </div>
            </div>
            <div class="fs-controls">
                <button class="fs-ctrl-btn" id="fsShuffleBtn" title="Shuffle">
                    <svg width="22" height="22" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </button>
                <button class="fs-ctrl-btn" id="fsPrevBtn" title="Previous">
                    <svg width="28" height="28" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="fs-ctrl-btn fs-play" id="fsPlayBtn" title="Play">
                    <svg viewBox="0 0 24 24" id="fsPlayIcon"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="fs-ctrl-btn" id="fsNextBtn" title="Next">
                    <svg width="28" height="28" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
                <button class="fs-ctrl-btn" id="fsRepeatBtn" title="Repeat">
                    <svg width="22" height="22" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </button>
            </div>
            <div class="fs-volume">
                <svg class="fs-vol-icon" viewBox="0 0 24 24" id="fsVolIcon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <div class="fs-vol-slider" id="fsVolSlider">
                    <div class="fs-vol-track"><div class="fs-vol-fill" id="fsVolFill"></div></div>
                    <div class="fs-vol-dot" id="fsVolDot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS OVERLAY -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-overlay-bg" onclick="closeSettings()"></div>
        <div class="settings-overlay-content">
            <button class="settings-close-btn" onclick="closeSettings()" title="Close">✕</button>
            <div class="settings-header">
                <h1>Settings</h1>
                <p>Account, appearance, and notifications</p>
            </div>

            <!-- Account Section -->
            <div class="stg-section-title">Account</div>
            <div id="stgProfileSection">
                <div class="stg-profile-field">
                    <label>Username</label>
                    <input type="text" id="stgUsername" readonly>
                    <div class="field-hint">Username cannot be changed</div>
                </div>
                <div class="stg-profile-row">
                    <div class="stg-profile-field">
                        <label>First Name</label>
                        <input type="text" id="stgFirstName">
                    </div>
                    <div class="stg-profile-field">
                        <label>Last Name</label>
                        <input type="text" id="stgLastName">
                    </div>
                </div>
                <div class="stg-profile-field">
                    <label>Email</label>
                    <input type="email" id="stgEmail">
                </div>
                <div class="stg-profile-field">
                    <label>Member Since</label>
                    <input type="text" id="stgJoined" readonly>
                </div>
                <button class="stg-save-btn" id="stgProfileSaveBtn" onclick="stgSaveProfile()">Save Profile</button>
                <div class="stg-status-msg" id="stgProfileStatus"></div>

                <div style="margin-top: 20px;">
                    <button class="stg-pw-toggle-btn" onclick="stgTogglePassword()">Change Password</button>
                    <div class="stg-pw-fields" id="stgPwFields">
                        <div class="stg-profile-field">
                            <label>Current Password</label>
                            <input type="password" id="stgCurrentPw" placeholder="Enter current password">
                        </div>
                        <div class="stg-profile-field">
                            <label>New Password</label>
                            <input type="password" id="stgNewPw" placeholder="Min 6 characters">
                        </div>
                        <div class="stg-profile-field">
                            <label>Confirm New Password</label>
                            <input type="password" id="stgConfirmPw" placeholder="Confirm new password">
                        </div>
                        <button class="stg-save-btn" onclick="stgChangePassword()" style="background: var(--red);">Update Password</button>
                        <div class="stg-status-msg" id="stgPwStatus"></div>
                    </div>
                </div>
            </div>

            <hr class="stg-section-divider">

            <!-- Appearance Section -->
            <div class="stg-section-title">Appearance</div>
            <div class="stg-theme-selector">
                <label class="stg-theme-option">
                    <input type="radio" name="stgThemePref" value="system">
                    <div>
                        <div class="stg-theme-option-label">System Default</div>
                        <div class="stg-theme-option-desc">Match your device settings</div>
                    </div>
                </label>
                <label class="stg-theme-option">
                    <input type="radio" name="stgThemePref" value="light">
                    <div>
                        <div class="stg-theme-option-label">Light Mode</div>
                        <div class="stg-theme-option-desc">Always use light theme</div>
                    </div>
                </label>
                <label class="stg-theme-option">
                    <input type="radio" name="stgThemePref" value="dark">
                    <div>
                        <div class="stg-theme-option-label">Dark Mode</div>
                        <div class="stg-theme-option-desc">Always use dark theme</div>
                    </div>
                </label>
            </div>

            <hr class="stg-section-divider">

            <!-- Email Notifications -->
            <div class="stg-section-title">Email Notifications</div>
            <div class="stg-global-toggle">
                <div>
                    <h3>Email Notifications</h3>
                    <p>Receive emails about new uploads</p>
                </div>
                <label class="stg-toggle-switch">
                    <input type="checkbox" id="stgGlobalToggle" checked>
                    <span class="stg-toggle-slider"></span>
                </label>
            </div>

            <div class="stg-section-title">Creator Subscriptions</div>
            <div id="stgSubsList"></div>

            <button class="stg-pref-save-btn" id="stgPrefSaveBtn" onclick="stgSavePreferences()">Save Preferences</button>
            <div class="stg-status-msg" id="stgPrefStatus"></div>

            <div style="text-align:center; margin-top:20px;">
                <a href="#" onclick="logout(); return false;" style="color:var(--text-secondary); font-size:0.85rem; text-decoration:none;">Sign Out</a>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        var API = window.location.origin;

        // Auth token helper — checks both localStorage and sessionStorage
        function getAuthToken() {
            return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }
        function logout() {
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }

        var audio = document.getElementById('audioPlayer');
        var tracks = [];
        var currentIndex = -1;
        var isPlaying = false;
        var shuffleOn = false;
        var repeatOn = false;
        var currentCreatorId = null;
        var currentProfileCreatorId = null;
        var isSubscribedToProfile = false;

        // ===== BROWSE / TOP CREATORS / SEARCH =====
        (async function init() {
            var token = getAuthToken();
            if (!token) { window.location.href = 'welcome.html'; return; }
            loadTopCreators();
        })();

        var searchTimeout = null;
        document.getElementById('searchInput').addEventListener('input', function() {
            var q = this.value.trim();
            clearTimeout(searchTimeout);
            if (!q) {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('topCreatorsSection').style.display = '';
                document.getElementById('profileView').classList.remove('active');
                return;
            }
            searchTimeout = setTimeout(function() { performSearch(q); }, 300);
        });

        async function loadTopCreators() {
            try {
                var resp = await fetch(API + '/api/creators-public/top?limit=20');
                var data = await resp.json();
                var grid = document.getElementById('topCreatorsGrid');
                grid.innerHTML = '';
                if (!data.creators || data.creators.length === 0) {
                    grid.innerHTML = '<p style="color:var(--text-secondary);padding:20px;text-align:center;">No creators yet. Be the first!</p>';
                    return;
                }
                data.creators.forEach(function(c) {
                    var card = document.createElement('div');
                    card.className = 'creator-card';
                    card.onclick = function() { openCreatorProfile(c.id); };
                    var photoHtml = c.profile_photo
                        ? '<img src="' + c.profile_photo + '">'
                        : escapeHtml((c.artist_name || c.username || '?').charAt(0).toUpperCase());
                    card.innerHTML =
                        '<div class="creator-card-photo">' + photoHtml + '</div>' +
                        '<h4>' + escapeHtml(c.artist_name || c.username) + '</h4>' +
                        '<p>' + (parseInt(c.subscriber_count) || 0) + ' subscriber' + ((parseInt(c.subscriber_count) || 0) !== 1 ? 's' : '') + '</p>';
                    grid.appendChild(card);
                });
            } catch (err) {
                console.error('Failed to load top creators:', err);
            }
        }

        async function performSearch(q) {
            try {
                var resp = await fetch(API + '/api/search?q=' + encodeURIComponent(q));
                var data = await resp.json();

                document.getElementById('topCreatorsSection').style.display = 'none';
                document.getElementById('profileView').classList.remove('active');
                var resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = '';
                resultsEl.classList.add('active');

                // Creators
                if (data.creators && data.creators.length > 0) {
                    resultsEl.innerHTML += '<h2 class="section-title" style="padding-left:0;">Creators</h2>';
                    var crGrid = document.createElement('div');
                    crGrid.className = 'creators-grid';
                    data.creators.forEach(function(c) {
                        var card = document.createElement('div');
                        card.className = 'creator-card';
                        card.onclick = function() { openCreatorProfile(c.id); };
                        var photoHtml = c.profile_photo
                            ? '<img src="' + c.profile_photo + '">'
                            : escapeHtml((c.artist_name || c.username || '?').charAt(0).toUpperCase());
                        card.innerHTML =
                            '<div class="creator-card-photo">' + photoHtml + '</div>' +
                            '<h4>' + escapeHtml(c.artist_name || c.username) + '</h4>' +
                            '<p>' + (parseInt(c.subscriber_count) || 0) + ' subscribers</p>';
                        crGrid.appendChild(card);
                    });
                    resultsEl.appendChild(crGrid);
                }

                // Songs
                if (data.songs && data.songs.length > 0) {
                    resultsEl.innerHTML += '<h2 class="section-title" style="padding-left:0;">Songs</h2>';
                    data.songs.forEach(function(s) {
                        var row = document.createElement('div');
                        row.className = 'search-result-song';
                        row.onclick = function() { playSingleSong(s); };
                        var artHtml = s.artwork_url
                            ? '<img src="' + s.artwork_url + '">'
                            : '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:var(--text-secondary);opacity:0.4"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                        row.innerHTML =
                            '<div class="sr-art">' + artHtml + '</div>' +
                            '<div class="sr-info"><h4>' + escapeHtml(s.title) + '</h4><p>' + escapeHtml(s.artist) + ' &middot; ' + escapeHtml(s.creator_artist_name || '') + '</p></div>';
                        resultsEl.appendChild(row);
                    });
                }

                if ((!data.creators || data.creators.length === 0) && (!data.songs || data.songs.length === 0)) {
                    resultsEl.innerHTML = '<p style="color:var(--text-secondary);padding:40px 0;text-align:center;">No results found</p>';
                }
            } catch (err) {
                console.error('Search error:', err);
            }
        }

        function playSingleSong(song) {
            tracks = [song];
            currentIndex = -1;
            currentCreatorId = song.creator_id;
            document.getElementById('nowPlayingBar').classList.add('active');
            playTrack(0);
        }

        async function openCreatorProfile(creatorId) {
            try {
                var token = getAuthToken();
                var headers = {};
                if (token) headers['Authorization'] = 'Bearer ' + token;

                var resp = await fetch(API + '/api/creators-public/' + creatorId + '/profile', { headers: headers });
                var data = await resp.json();

                currentProfileCreatorId = creatorId;
                isSubscribedToProfile = data.isSubscribed;

                // Hide top creators and search, show profile
                document.getElementById('topCreatorsSection').style.display = 'none';
                document.getElementById('searchResults').classList.remove('active');
                var pv = document.getElementById('profileView');
                pv.classList.add('active');

                // Photo
                var photoEl = document.getElementById('profilePhoto');
                if (data.creator.profile_photo) {
                    photoEl.innerHTML = '<img src="' + data.creator.profile_photo + '">';
                } else {
                    photoEl.textContent = (data.creator.artist_name || data.creator.username || '?').charAt(0).toUpperCase();
                }

                document.getElementById('profileName').textContent = data.creator.artist_name || data.creator.username;
                document.getElementById('profileBio').textContent = data.creator.bio || '';
                var subCount = parseInt(data.creator.subscriber_count) || 0;
                document.getElementById('profileStats').textContent = subCount + ' subscriber' + (subCount !== 1 ? 's' : '') + ' \u00b7 ' + (data.songs ? data.songs.length : 0) + ' songs';

                // Subscribe button
                updateSubscribeBtn();

                // Song list
                var listEl = document.getElementById('profileTracksList');
                if (!data.songs || data.songs.length === 0) {
                    listEl.innerHTML = '<div class="empty-tracks"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No tracks uploaded yet.</p></div>';
                    return;
                }

                // Store tracks for playback
                tracks = data.songs;
                currentCreatorId = creatorId;
                listEl.innerHTML = '';
                tracks.forEach(function(track, i) {
                    var row = document.createElement('div');
                    row.className = 'track-row' + (i === currentIndex ? ' active' : '');
                    row.onclick = function() { playTrack(i); };
                    var artHtml = track.artwork_url
                        ? '<img src="' + track.artwork_url + '">'
                        : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                    var descHtml = track.description ? '<p style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(track.description) + '</p>' : '';
                    row.innerHTML = '<div class="tr-num">' + (i + 1) + '</div>' +
                        '<div class="tr-art">' + artHtml + '</div>' +
                        '<div class="tr-info"><h4>' + escapeHtml(track.title) + '</h4><p>' + escapeHtml(track.artist) + '</p>' + descHtml + '</div>' +
                        '<div class="tr-duration" id="dur-' + i + '">--:--</div>';
                    listEl.appendChild(row);
                });
            } catch (err) {
                console.error('Failed to load creator profile:', err);
            }
        }

        function updateSubscribeBtn() {
            var btn = document.getElementById('subscribeBtn');
            if (isSubscribedToProfile) {
                btn.className = 'subscribe-btn subscribed';
                btn.textContent = 'Subscribed \u2713';
            } else {
                btn.className = 'subscribe-btn';
                btn.textContent = 'Subscribe';
            }
        }

        async function toggleSubscribe() {
            var token = getAuthToken();
            if (!token) return;
            try {
                if (isSubscribedToProfile) {
                    await fetch(API + '/api/creators-public/' + currentProfileCreatorId + '/subscribe', {
                        method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
                    });
                    isSubscribedToProfile = false;
                } else {
                    await fetch(API + '/api/creators-public/' + currentProfileCreatorId + '/subscribe', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
                    });
                    isSubscribedToProfile = true;
                }
                updateSubscribeBtn();
            } catch (err) {
                console.error('Subscribe toggle error:', err);
            }
        }

        function showBrowse() {
            document.getElementById('profileView').classList.remove('active');
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('topCreatorsSection').style.display = '';
            document.getElementById('searchInput').value = '';
        }

        // ===== ADAPTIVE COLOR EXTRACTION =====
        function extractColors(imgUrl) {
            if (!imgUrl) return;
            var img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var size = 50;
                canvas.width = size; canvas.height = size;
                ctx.drawImage(img, 0, 0, size, size);
                var data = ctx.getImageData(0, 0, size, size).data;

                // Sample colors from different quadrants
                var colors = { tl: [0,0,0], tr: [0,0,0], bl: [0,0,0], br: [0,0,0], center: [0,0,0] };
                var half = Math.floor(size / 2);
                var counts = { tl: 0, tr: 0, bl: 0, br: 0, center: 0 };

                for (var y = 0; y < size; y++) {
                    for (var x = 0; x < size; x++) {
                        var idx = (y * size + x) * 4;
                        var r = data[idx], g = data[idx+1], b = data[idx+2];
                        // Skip very dark or very light pixels
                        var brightness = (r + g + b) / 3;
                        if (brightness < 20 || brightness > 240) continue;

                        var region;
                        if (x < half && y < half) region = 'tl';
                        else if (x >= half && y < half) region = 'tr';
                        else if (x < half && y >= half) region = 'bl';
                        else region = 'br';

                        // Also sample center
                        if (x > size*0.25 && x < size*0.75 && y > size*0.25 && y < size*0.75) {
                            colors.center[0] += r; colors.center[1] += g; colors.center[2] += b;
                            counts.center++;
                        }

                        colors[region][0] += r; colors[region][1] += g; colors[region][2] += b;
                        counts[region]++;
                    }
                }

                // Average each region
                var avgColors = {};
                for (var key in colors) {
                    if (counts[key] > 0) {
                        avgColors[key] = [
                            Math.round(colors[key][0] / counts[key]),
                            Math.round(colors[key][1] / counts[key]),
                            Math.round(colors[key][2] / counts[key])
                        ];
                    } else {
                        avgColors[key] = [80, 80, 80];
                    }
                }

                // Pick two most vibrant/different colors
                var primary = avgColors.center;
                var secondary = avgColors.tl;

                // Find the most different color from primary
                var maxDist = 0;
                for (var k in avgColors) {
                    if (k === 'center') continue;
                    var d = Math.abs(avgColors[k][0] - primary[0]) +
                            Math.abs(avgColors[k][1] - primary[1]) +
                            Math.abs(avgColors[k][2] - primary[2]);
                    if (d > maxDist) { maxDist = d; secondary = avgColors[k]; }
                }

                applyAdaptiveColors(primary, secondary);
            };
            img.src = imgUrl;
        }

        function applyAdaptiveColors(primary, secondary) {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var bgEl = document.getElementById('adaptiveBg');

            // Set CSS variable for track highlighting
            document.documentElement.style.setProperty('--art-primary', primary.join(','));
            document.documentElement.style.setProperty('--art-secondary', secondary.join(','));

            // Build gradient overlay
            var pAlpha = isDark ? 0.25 : 0.12;
            var sAlpha = isDark ? 0.18 : 0.08;
            bgEl.style.background =
                'radial-gradient(ellipse at top left, rgba(' + primary.join(',') + ',' + pAlpha + ') 0%, transparent 60%), ' +
                'radial-gradient(ellipse at bottom right, rgba(' + secondary.join(',') + ',' + sAlpha + ') 0%, transparent 60%), ' +
                'radial-gradient(ellipse at center, rgba(' + primary.join(',') + ',' + (pAlpha * 0.4) + ') 0%, transparent 50%)';
            bgEl.classList.add('active');

            // Tint the hero art shadow
            var heroArt = document.getElementById('heroArt');
            heroArt.style.boxShadow = '0 16px 60px rgba(' + primary.join(',') + ',0.35), 0 8px 30px rgba(' + secondary.join(',') + ',0.2)';
        }

        async function loadTracks(creatorId) {
            try {
                var url = creatorId ? API + '/api/tracks?creator_id=' + creatorId : API + '/api/tracks';
                var response = await fetch(url);
                var data = await response.json();
                tracks = data.tracks || [];
                document.getElementById('libraryMeta').textContent = tracks.length + ' track' + (tracks.length !== 1 ? 's' : '');

                // Set hero art to first track's artwork if available
                if (tracks.length > 0 && tracks[0].artwork_url) {
                    document.getElementById('heroArt').innerHTML = '<img src="' + tracks[0].artwork_url + '">';
                    extractColors(tracks[0].artwork_url);
                }

                renderTracks();
            } catch (err) {
                console.error('Error loading tracks:', err);
            }
        }

        function renderTracks() {
            var list = document.getElementById('tracksList');
            if (tracks.length === 0) {
                list.innerHTML = '<div class="empty-tracks"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No tracks uploaded yet.</p></div>';
                return;
            }
            list.innerHTML = '';
            tracks.forEach(function(track, i) {
                var row = document.createElement('div');
                row.className = 'track-row' + (i === currentIndex ? ' active' : '');
                row.onclick = function() { playTrack(i); };
                var artHtml = track.artwork_url
                    ? '<img src="' + track.artwork_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                row.innerHTML = '<div class="tr-num">' + (i + 1) + '</div>' +
                    '<div class="tr-art">' + artHtml + '</div>' +
                    '<div class="tr-info"><h4>' + escapeHtml(track.title) + '</h4><p>' + escapeHtml(track.artist) + '</p></div>' +
                    '<div class="tr-duration" id="dur-' + i + '">--:--</div>';
                list.appendChild(row);
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= tracks.length) return;
            currentIndex = index;
            var track = tracks[index];
            audio.src = track.audio_url;
            audio.play();

            // Update now playing bar
            document.getElementById('nowPlayingBar').classList.add('active');
            document.getElementById('npbTitle').textContent = track.title;
            document.getElementById('npbArtist').textContent = track.artist;
            if (track.artwork_url) {
                document.getElementById('npbArt').innerHTML = '<img src="' + track.artwork_url + '">';
                // Update hero art and extract colors for this track
                document.getElementById('heroArt').innerHTML = '<img src="' + track.artwork_url + '">';
                extractColors(track.artwork_url);
            } else {
                document.getElementById('npbArt').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
            }

            // Highlight active row
            document.querySelectorAll('.track-row').forEach(function(r, i) {
                r.classList.toggle('active', i === index);
            });

            // Sync full-screen player if open
            if (fsOpen) setTimeout(syncFullScreenPlayer, 50);
        }

        function playAll() {
            if (tracks.length > 0) playTrack(0);
        }

        function togglePlay() {
            if (currentIndex === -1 && tracks.length > 0) { playTrack(0); return; }
            if (isPlaying) audio.pause();
            else audio.play();
        }

        function nextTrack() {
            if (tracks.length === 0) return;
            var next = shuffleOn ? Math.floor(Math.random() * tracks.length) : currentIndex + 1;
            if (next >= tracks.length) next = 0;
            playTrack(next);
        }

        function prevTrack() {
            if (tracks.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            var prev = currentIndex - 1;
            if (prev < 0) prev = tracks.length - 1;
            playTrack(prev);
        }

        function toggleShuffle() {
            shuffleOn = !shuffleOn;
            document.getElementById('shuffleBtn').classList.toggle('active-mode', shuffleOn);
        }

        function toggleRepeat() {
            repeatOn = !repeatOn;
            document.getElementById('repeatBtn').classList.toggle('active-mode', repeatOn);
        }

        // ===== CUSTOM VOLUME SLIDER =====
        var volSlider = document.getElementById('volSlider');
        var volFill = document.getElementById('volFill');
        var volDot = document.getElementById('volDot');
        var volDragging = false;
        var currentVol = 80;
        var prevVol = 80;

        function setVolume(val) {
            currentVol = Math.max(0, Math.min(100, val));
            audio.volume = currentVol / 100;
            volFill.style.width = currentVol + '%';
            volDot.style.left = currentVol + '%';
            // Scale dot: 10px at 0%, 16px at 100%
            var dotSize = 10 + (currentVol / 100) * 6;
            volDot.style.width = dotSize + 'px';
            volDot.style.height = dotSize + 'px';
            // Sync full-screen volume display
            if (typeof fsOpen !== 'undefined' && fsOpen) {
                document.getElementById('fsVolFill').style.width = currentVol + '%';
                document.getElementById('fsVolDot').style.left = currentVol + '%';
            }
        }

        function volFromEvent(e) {
            var rect = volSlider.getBoundingClientRect();
            var pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
            setVolume(pct);
        }

        volSlider.addEventListener('mousedown', function(e) {
            volDragging = true;
            volSlider.classList.add('dragging');
            volFromEvent(e);
            e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (volDragging) volFromEvent(e);
        });
        document.addEventListener('mouseup', function() {
            if (volDragging) { volDragging = false; volSlider.classList.remove('dragging'); }
        });
        // Touch support
        volSlider.addEventListener('touchstart', function(e) {
            volDragging = true;
            volSlider.classList.add('dragging');
            volFromEvent(e.touches[0]);
            e.preventDefault();
        }, { passive: false });
        document.addEventListener('touchmove', function(e) {
            if (volDragging) volFromEvent(e.touches[0]);
        });
        document.addEventListener('touchend', function() {
            if (volDragging) { volDragging = false; volSlider.classList.remove('dragging'); }
        });

        function toggleMute() {
            if (currentVol > 0) { prevVol = currentVol; setVolume(0); }
            else { setVolume(prevVol || 80); }
        }

        // Initialize volume display
        setVolume(80);

        function seekFromBar(e, bar) {
            if (!audio.duration) return;
            var rect = bar.getBoundingClientRect();
            var pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.currentTime = pct * audio.duration;
        }

        // Audio events
        audio.addEventListener('play', function() {
            isPlaying = true;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
            if (fsOpen) updateFsPlayIcon();
        });
        audio.addEventListener('pause', function() {
            isPlaying = false;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
            if (fsOpen) updateFsPlayIcon();
        });
        audio.addEventListener('timeupdate', function() {
            if (!audio.duration) return;
            var pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('npbProgressTopFill').style.width = pct + '%';
            document.getElementById('npbTimeFill').style.width = pct + '%';
            document.getElementById('npbCurrentTime').textContent = formatTime(audio.currentTime);
            document.getElementById('npbDuration').textContent = formatTime(audio.duration);
            if (fsOpen) {
                document.getElementById('fsTimeFill').style.width = pct + '%';
                document.getElementById('fsCurrentTime').textContent = formatTime(audio.currentTime);
                document.getElementById('fsDuration').textContent = formatTime(audio.duration);
            }
        });
        audio.addEventListener('loadedmetadata', function() {
            if (currentIndex >= 0) {
                var durEl = document.getElementById('dur-' + currentIndex);
                if (durEl) durEl.textContent = formatTime(audio.duration);
            }
        });
        audio.addEventListener('ended', function() {
            if (repeatOn) { audio.currentTime = 0; audio.play(); }
            else nextTrack();
        });

        function formatTime(s) {
            if (isNaN(s)) return '--:--';
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Theme (managed via Settings page)
        (function() {
            var old = localStorage.getItem('theme');
            if (old && !localStorage.getItem('themePreference')) {
                localStorage.setItem('themePreference', old);
                localStorage.removeItem('theme');
            }
            var pref = localStorage.getItem('themePreference') || 'system';
            if (pref === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
            else if (pref === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
            else document.documentElement.setAttribute('data-theme', 'light');
        })();
        // Listen for system theme changes when set to 'system'
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
                var pref = localStorage.getItem('themePreference') || 'system';
                if (pref === 'system') {
                    document.documentElement.setAttribute('data-theme',
                        window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                }
            });
        }
        // ===== FULL-SCREEN PLAYER =====
        var fsPlayer = document.getElementById('fsPlayer');
        var fsOpen = false;

        function openFullScreenPlayer() {
            if (currentIndex < 0) return;
            syncFullScreenPlayer();
            fsPlayer.classList.add('active');
            fsOpen = true;
            document.body.style.overflow = 'hidden';
        }

        function closeFullScreenPlayer() {
            fsPlayer.classList.remove('active');
            fsOpen = false;
            document.body.style.overflow = '';
        }

        function updateFsPlayIcon() {
            document.getElementById('fsPlayIcon').innerHTML = isPlaying
                ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
                : '<path d="M8 5v14l11-7z"/>';
        }

        function syncFullScreenPlayer() {
            if (currentIndex < 0) return;
            var track = tracks[currentIndex];

            // Art
            var fsArt = document.getElementById('fsArt');
            if (track.artwork_url) {
                fsArt.innerHTML = '<img src="' + track.artwork_url + '">';
            } else {
                fsArt.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
            }

            // Track info
            document.getElementById('fsTitle').textContent = track.title;
            document.getElementById('fsArtist').textContent = track.artist;

            // Credits
            var creditsEl = document.getElementById('fsCredits');
            var creditsHtml = '';
            var hasAny = false;
            var creditFields = [
                { key: 'credits_producer', label: 'Produced by' },
                { key: 'credits_writer', label: 'Written by' },
                { key: 'credits_engineer', label: 'Engineered by' },
                { key: 'credits_mixer', label: 'Mixed by' },
                { key: 'credits_master', label: 'Mastered by' }
            ];
            creditFields.forEach(function(f) {
                if (track[f.key]) {
                    hasAny = true;
                    creditsHtml += '<div class="fs-credit-row"><span class="fs-credit-role">' +
                        f.label + '</span><span class="fs-credit-name">' + escapeHtml(track[f.key]) + '</span></div>';
                }
            });
            if (hasAny) {
                creditsEl.innerHTML = '<h5>Credits</h5>' + creditsHtml;
                creditsEl.classList.add('has-credits');
            } else {
                creditsEl.innerHTML = '';
                creditsEl.classList.remove('has-credits');
            }

            // Play/pause icon
            updateFsPlayIcon();

            // Shuffle/Repeat state
            document.getElementById('fsShuffleBtn').classList.toggle('active-mode', shuffleOn);
            document.getElementById('fsRepeatBtn').classList.toggle('active-mode', repeatOn);

            // Volume
            document.getElementById('fsVolFill').style.width = currentVol + '%';
            document.getElementById('fsVolDot').style.left = currentVol + '%';

            // Progress
            if (audio.duration) {
                var pct = (audio.currentTime / audio.duration) * 100;
                document.getElementById('fsTimeFill').style.width = pct + '%';
                document.getElementById('fsCurrentTime').textContent = formatTime(audio.currentTime);
                document.getElementById('fsDuration').textContent = formatTime(audio.duration);
            }
        }

        // Close button
        document.getElementById('fsCloseBtn').addEventListener('click', closeFullScreenPlayer);

        // Click on now-playing bar to open (but NOT on buttons/sliders/progress)
        document.getElementById('nowPlayingBar').addEventListener('click', function(e) {
            if (e.target.closest('button, .npb-vol-slider, .npb-progress, .npb-time-bar, svg, .npb-vol-icon')) return;
            if (currentIndex >= 0) openFullScreenPlayer();
        });

        // FS Controls
        document.getElementById('fsPlayBtn').addEventListener('click', function() { togglePlay(); });
        document.getElementById('fsNextBtn').addEventListener('click', function() {
            nextTrack();
            setTimeout(syncFullScreenPlayer, 100);
        });
        document.getElementById('fsPrevBtn').addEventListener('click', function() {
            prevTrack();
            setTimeout(syncFullScreenPlayer, 100);
        });
        document.getElementById('fsShuffleBtn').addEventListener('click', function() {
            toggleShuffle();
            document.getElementById('fsShuffleBtn').classList.toggle('active-mode', shuffleOn);
        });
        document.getElementById('fsRepeatBtn').addEventListener('click', function() {
            toggleRepeat();
            document.getElementById('fsRepeatBtn').classList.toggle('active-mode', repeatOn);
        });

        // FS Seek
        document.getElementById('fsTimeBar').addEventListener('click', function(e) {
            seekFromBar(e, this);
        });

        // FS Mute toggle
        document.getElementById('fsVolIcon').addEventListener('click', function() {
            toggleMute();
            document.getElementById('fsVolFill').style.width = currentVol + '%';
            document.getElementById('fsVolDot').style.left = currentVol + '%';
        });

        // FS Volume slider
        var fsVolSlider = document.getElementById('fsVolSlider');
        var fsVolDragging = false;
        function fsVolFromEvent(e) {
            var rect = fsVolSlider.getBoundingClientRect();
            var pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
            setVolume(pct);
            document.getElementById('fsVolFill').style.width = currentVol + '%';
            document.getElementById('fsVolDot').style.left = currentVol + '%';
        }
        fsVolSlider.addEventListener('mousedown', function(e) {
            fsVolDragging = true; fsVolFromEvent(e); e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (fsVolDragging) fsVolFromEvent(e);
        });
        document.addEventListener('mouseup', function() {
            if (fsVolDragging) fsVolDragging = false;
        });
        fsVolSlider.addEventListener('touchstart', function(e) {
            fsVolDragging = true; fsVolFromEvent(e.touches[0]); e.preventDefault();
        }, { passive: false });
        document.addEventListener('touchmove', function(e) {
            if (fsVolDragging) fsVolFromEvent(e.touches[0]);
        });
        document.addEventListener('touchend', function() {
            if (fsVolDragging) fsVolDragging = false;
        });

        // Escape to close
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && fsOpen) closeFullScreenPlayer();
        });

        // Swipe down to close on mobile
        (function() {
            var startY = 0;
            var fsContent = document.querySelector('.fs-player-content');
            fsContent.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            }, { passive: true });
            fsContent.addEventListener('touchend', function(e) {
                var dy = e.changedTouches[0].clientY - startY;
                if (dy > 80) closeFullScreenPlayer();
            }, { passive: true });
        })();
        // ===== SETTINGS OVERLAY =====
        var settingsLoaded = false;

        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            if (!settingsLoaded) loadSettingsData();
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close settings on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('settingsOverlay').classList.contains('active')) {
                closeSettings();
            }
        });

        async function loadSettingsData() {
            var token = getAuthToken();
            if (!token) return;

            // Load profile
            try {
                var profileResp = await fetch(API + '/api/listeners/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (profileResp.ok) {
                    var profileData = await profileResp.json();
                    var l = profileData.listener;
                    document.getElementById('stgUsername').value = l.username || '';
                    document.getElementById('stgFirstName').value = l.first_name || '';
                    document.getElementById('stgLastName').value = l.last_name || '';
                    document.getElementById('stgEmail').value = l.email || '';
                    if (l.created_at) {
                        document.getElementById('stgJoined').value = new Date(l.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                }
            } catch (err) {
                console.error('Settings: failed to load profile:', err);
            }

            // Load email preferences
            try {
                var resp = await fetch(API + '/api/listeners/email-preferences', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (resp.ok) {
                    var data = await resp.json();
                    document.getElementById('stgGlobalToggle').checked = data.email_notifications !== false;
                    var list = document.getElementById('stgSubsList');
                    if (data.subscriptions.length === 0) {
                        list.innerHTML = '<div class="stg-no-subs">No creator subscriptions yet. Subscribe to creators to get started.</div>';
                    } else {
                        list.innerHTML = '';
                        data.subscriptions.forEach(function(sub) {
                            var name = sub.artist_name || sub.username;
                            var initial = name.charAt(0).toUpperCase();
                            var div = document.createElement('div');
                            div.className = 'stg-creator-sub';
                            div.innerHTML =
                                '<div class="stg-creator-sub-info">' +
                                    '<div class="stg-creator-sub-icon"><svg viewBox="0 0 24 24"><text x="12" y="17" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--green)">' + escapeHtml(initial) + '</text></svg></div>' +
                                    '<div><div class="stg-creator-sub-name">' + escapeHtml(name) + '</div>' +
                                    '<div class="stg-creator-sub-detail">' + escapeHtml((sub.first_name || '') + ' ' + (sub.last_name || '')).trim() + '</div></div>' +
                                '</div>' +
                                '<label class="stg-toggle-switch">' +
                                    '<input type="checkbox" data-stg-creator-id="' + sub.creator_id + '"' + (sub.email_on_upload ? ' checked' : '') + '>' +
                                    '<span class="stg-toggle-slider"></span>' +
                                '</label>';
                            list.appendChild(div);
                        });
                    }
                }
            } catch (err) {
                console.error('Settings: failed to load preferences:', err);
                document.getElementById('stgSubsList').innerHTML = '<div class="stg-no-subs">Failed to load preferences.</div>';
            }

            // Set theme radio
            var currentPref = localStorage.getItem('themePreference') || 'system';
            var radio = document.querySelector('input[name="stgThemePref"][value="' + currentPref + '"]');
            if (radio) radio.checked = true;

            settingsLoaded = true;
        }

        // Theme radio change — apply immediately
        document.querySelectorAll('input[name="stgThemePref"]').forEach(function(r) {
            r.addEventListener('change', function() {
                var pref = this.value;
                localStorage.setItem('themePreference', pref);
                if (pref === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
                else if (pref === 'light') document.documentElement.setAttribute('data-theme', 'light');
                else {
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches)
                        document.documentElement.setAttribute('data-theme', 'dark');
                    else
                        document.documentElement.setAttribute('data-theme', 'light');
                }
            });
        });

        // Save profile
        async function stgSaveProfile() {
            var token = getAuthToken();
            if (!token) return;
            var btn = document.getElementById('stgProfileSaveBtn');
            var statusEl = document.getElementById('stgProfileStatus');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            statusEl.className = 'stg-status-msg';
            statusEl.style.display = 'none';
            try {
                var resp = await fetch(API + '/api/listeners/me', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({
                        first_name: document.getElementById('stgFirstName').value.trim(),
                        last_name: document.getElementById('stgLastName').value.trim(),
                        email: document.getElementById('stgEmail').value.trim()
                    })
                });
                var data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed to save');
                statusEl.textContent = 'Profile updated successfully!';
                statusEl.className = 'stg-status-msg success';
            } catch (err) {
                statusEl.textContent = err.message || 'Failed to save profile.';
                statusEl.className = 'stg-status-msg error';
            }
            btn.disabled = false;
            btn.textContent = 'Save Profile';
            setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
        }

        // Toggle password fields
        function stgTogglePassword() {
            document.getElementById('stgPwFields').classList.toggle('visible');
        }

        // Change password
        async function stgChangePassword() {
            var token = getAuthToken();
            if (!token) return;
            var statusEl = document.getElementById('stgPwStatus');
            var newPw = document.getElementById('stgNewPw').value;
            var confirmPw = document.getElementById('stgConfirmPw').value;
            if (newPw !== confirmPw) {
                statusEl.textContent = 'New passwords do not match.';
                statusEl.className = 'stg-status-msg error';
                return;
            }
            if (newPw.length < 6) {
                statusEl.textContent = 'New password must be at least 6 characters.';
                statusEl.className = 'stg-status-msg error';
                return;
            }
            var btn = document.querySelector('#stgPwFields .stg-save-btn');
            btn.disabled = true;
            btn.textContent = 'Updating...';
            statusEl.className = 'stg-status-msg';
            statusEl.style.display = 'none';
            try {
                var resp = await fetch(API + '/api/listeners/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({
                        current_password: document.getElementById('stgCurrentPw').value,
                        new_password: newPw
                    })
                });
                var data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed to change password');
                statusEl.textContent = 'Password updated successfully!';
                statusEl.className = 'stg-status-msg success';
                document.getElementById('stgCurrentPw').value = '';
                document.getElementById('stgNewPw').value = '';
                document.getElementById('stgConfirmPw').value = '';
            } catch (err) {
                statusEl.textContent = err.message || 'Failed to change password.';
                statusEl.className = 'stg-status-msg error';
            }
            btn.disabled = false;
            btn.textContent = 'Update Password';
            setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
        }

        // Save email preferences
        async function stgSavePreferences() {
            var token = getAuthToken();
            if (!token) return;
            var btn = document.getElementById('stgPrefSaveBtn');
            var statusEl = document.getElementById('stgPrefStatus');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            statusEl.className = 'stg-status-msg';
            statusEl.style.display = 'none';
            var email_notifications = document.getElementById('stgGlobalToggle').checked;
            var subscriptions = [];
            document.querySelectorAll('[data-stg-creator-id]').forEach(function(input) {
                subscriptions.push({
                    creator_id: input.getAttribute('data-stg-creator-id'),
                    email_on_upload: input.checked
                });
            });
            try {
                var resp = await fetch(API + '/api/listeners/email-preferences', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ email_notifications: email_notifications, subscriptions: subscriptions })
                });
                if (!resp.ok) throw new Error('Failed to save');
                statusEl.textContent = 'Preferences saved successfully!';
                statusEl.className = 'stg-status-msg success';
            } catch (err) {
                statusEl.textContent = 'Failed to save preferences. Please try again.';
                statusEl.className = 'stg-status-msg error';
            }
            btn.disabled = false;
            btn.textContent = 'Save Preferences';
            setTimeout(function() { statusEl.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
