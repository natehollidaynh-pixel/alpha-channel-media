<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - Alpha Channel Media</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f0ede8;
            --bg-glossy: linear-gradient(135deg, #f5f2ed 0%, #faf8f5 20%, #f0ede8 40%, #fdf5f5 60%, #f0f7f3 80%, #f5f2ed 100%);
            --surface: rgba(255,255,255,0.55);
            --surface-solid: #ffffff;
            --green: #006e45; --green-glow: rgba(0,110,69,0.25); --red: #b82e2e; --red-glow: rgba(184,46,46,0.2);
            --text: #111111; --text-secondary: #555555; --border: rgba(0,0,0,0.08);
            --panel-glow: 0 0 30px rgba(0,110,69,0.12), 0 0 60px rgba(184,46,46,0.08);
            --panel-border: rgba(0,0,0,0.06); --input-bg: rgba(255,255,255,0.7);
            --track-hover: rgba(0,110,69,0.06);
            --shimmer-color: rgba(0,110,69,0.15);
            /* Adaptive colors (updated by JS) */
            --art-primary: 0,110,69;
            --art-secondary: 184,46,46;
        }
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-glossy: linear-gradient(135deg, #0e0e0e 0%, #121210 20%, #0e100e 40%, #140e0e 60%, #0e1210 80%, #0e0e0e 100%);
            --surface: rgba(25,25,25,0.7);
            --surface-solid: #141414;
            --green: #00c97a; --green-glow: rgba(0,201,122,0.2); --red: #e04545; --red-glow: rgba(224,69,69,0.15);
            --text: #eaeaea; --text-secondary: #999999; --border: rgba(255,255,255,0.08);
            --panel-glow: 0 0 40px rgba(0,201,122,0.1), 0 0 80px rgba(224,69,69,0.06);
            --panel-border: rgba(255,255,255,0.06); --input-bg: rgba(40,40,40,0.7);
            --track-hover: rgba(0,201,122,0.06);
            --shimmer-color: rgba(0,201,122,0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-glossy);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        /* Glossy orbs */
        body::before, body::after {
            content: ''; position: fixed; border-radius: 50%;
            filter: blur(80px); opacity: 0.4; pointer-events: none; z-index: 0;
        }
        body::before {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(0,150,80,0.2), transparent 70%);
            top: -100px; right: -100px;
        }
        body::after {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(200,40,40,0.15), transparent 70%);
            bottom: -50px; left: -50px;
        }

        /* Adaptive color overlay — driven by artwork */
        .adaptive-bg {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            transition: opacity 1.5s ease;
            opacity: 0;
        }
        .adaptive-bg.active { opacity: 1; }

        /* Shimmer text */
        .shimmer-text {
            background: linear-gradient(120deg, var(--text) 0%, var(--text) 40%, var(--shimmer-color) 50%, var(--text) 60%, var(--text) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }

        .back-arrow {
            position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            backdrop-filter: blur(10px); text-decoration: none; transition: all 0.3s;
        }
        .back-arrow:hover { box-shadow: var(--panel-glow); }
        .back-arrow svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .theme-toggle {
            position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            backdrop-filter: blur(10px); transition: all 0.3s;
        }
        .theme-toggle:hover { box-shadow: var(--panel-glow); }
        .theme-toggle svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .theme-toggle .icon-sun { display: none; }
        [data-theme="dark"] .theme-toggle .icon-moon { display: none; }
        [data-theme="dark"] .theme-toggle .icon-sun { display: block; }

        /* Gate */
        .gate-container {
            display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;
            position: relative; z-index: 1;
        }
        .gate-box {
            max-width: 440px; width: 100%; background: var(--surface); backdrop-filter: blur(25px);
            border-radius: 24px; border: 1px solid var(--panel-border); box-shadow: var(--panel-glow);
            padding: 48px 36px; text-align: center;
        }
        .gate-icon { margin-bottom: 20px; }
        .gate-icon svg { width: 56px; height: 56px; fill: var(--green); opacity: 0.7; }
        .gate-box h2 { margin-bottom: 8px; color: var(--text); font-size: 1.5rem; }
        .gate-box p { color: var(--text-secondary); margin-bottom: 28px; font-size: 0.95rem; }
        .gate-input {
            width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 12px;
            margin-bottom: 16px; font-size: 1.8rem; text-align: center; letter-spacing: 10px;
            font-family: monospace; background: var(--input-bg); color: var(--text); font-weight: 600;
        }
        .gate-input:focus { outline: none; border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
        .gate-btn {
            width: 100%; padding: 16px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: opacity 0.2s;
        }
        .gate-btn:hover { opacity: 0.85; }

        /* Main player layout */
        .player-app { display: none; min-height: 100vh; padding-bottom: 160px; position: relative; z-index: 1; }
        .player-app.active { display: block; }

        /* Header bar */
        .player-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(var(--art-primary), 0.05);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            transition: background 1s ease;
        }
        .player-header-left { display: flex; align-items: center; gap: 12px; margin-left: 40px; }
        .player-header-left h1 { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .player-header-right { display: flex; align-items: center; gap: 16px; margin-right: 40px; }
        .player-header-right a { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .player-header-right a:hover { color: var(--green); }

        /* Hero artwork section — large, immersive */
        .hero-section {
            position: relative;
            padding: 48px 20px 36px;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }
        .hero-inner {
            max-width: 900px; width: 100%;
            display: flex; align-items: flex-end; gap: 36px;
        }
        .hero-art {
            width: 320px; height: 320px; border-radius: 20px;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; flex-shrink: 0;
            box-shadow: 0 16px 60px rgba(0,0,0,0.25);
            transition: box-shadow 1s ease;
        }
        .hero-art img { width: 100%; height: 100%; object-fit: cover; }
        .hero-art svg { width: 80px; height: 80px; fill: var(--text-secondary); opacity: 0.3; }
        .hero-info { flex: 1; padding-bottom: 8px; }
        .hero-type { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; }
        .hero-title { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .hero-artist { font-size: 1rem; color: var(--green); font-weight: 500; margin-bottom: 12px; }
        .hero-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .play-all-btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 14px 32px;
            background: var(--green); color: white; border: none; border-radius: 24px;
            font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: all 0.2s;
        }
        .play-all-btn:hover { opacity: 0.85; transform: scale(1.02); }
        .play-all-btn svg { width: 20px; height: 20px; fill: white; }
        .change-key-link {
            display: inline-block; margin-top: 8px; color: var(--text-secondary);
            text-decoration: none; font-size: 0.85rem;
        }
        .change-key-link:hover { color: var(--green); }

        /* Track list */
        .track-list-container { max-width: 900px; margin: 0 auto; padding: 0 20px 24px; }

        /* Track rows */
        .track-table { width: 100%; }
        .track-table-header {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 8px 12px; border-bottom: 1px solid var(--border);
            color: var(--text-secondary); font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .track-row {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 10px 12px; border-radius: 10px; cursor: pointer;
            align-items: center; transition: background 0.15s;
        }
        .track-row:hover { background: var(--track-hover); }
        .track-row.active { background: rgba(var(--art-primary), 0.12); }
        .track-row .tr-num { text-align: center; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .track-row.active .tr-num { color: var(--green); }
        .track-row .tr-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .track-row .tr-art img { width: 100%; height: 100%; object-fit: cover; }
        .track-row .tr-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .track-row .tr-info { min-width: 0; }
        .track-row .tr-info h4 {
            font-size: 0.95rem; font-weight: 500; color: var(--text); margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-row.active .tr-info h4 { color: var(--green); }
        .track-row .tr-info p { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-row .tr-duration { font-size: 0.85rem; color: var(--text-secondary); text-align: right; }

        /* Now Playing Bar (fixed bottom) */
        .now-playing-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
            background: var(--surface-solid); border-top: 1px solid var(--border);
            backdrop-filter: blur(25px); display: none;
        }
        .now-playing-bar.active { display: block; }
        .npb-progress {
            width: 100%; height: 3px; background: var(--border); cursor: pointer; position: relative;
        }
        .npb-progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.15s linear; }
        .npb-content {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px;
            padding: 10px 20px; padding-bottom: max(10px, env(safe-area-inset-bottom));
            align-items: center; max-width: 1200px; margin: 0 auto;
        }
        .npb-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
        .npb-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
        }
        .npb-art img { width: 100%; height: 100%; object-fit: cover; }
        .npb-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .npb-track-info { min-width: 0; }
        .npb-track-info h4 { font-size: 0.9rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-track-info p { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-center { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .npb-controls { display: flex; align-items: center; gap: 20px; }
        .npb-btn {
            background: none; border: none; cursor: pointer; padding: 6px; display: flex;
            align-items: center; justify-content: center; transition: transform 0.15s;
        }
        .npb-btn:hover { transform: scale(1.1); }
        .npb-btn:active { transform: scale(0.95); }
        .npb-btn svg { fill: var(--text); }
        .npb-btn.npb-play {
            width: 40px; height: 40px; background: var(--green); border-radius: 50%;
        }
        .npb-btn.npb-play svg { fill: white; width: 18px; height: 18px; }
        .npb-btn.active-mode svg { fill: var(--green); }
        .npb-times { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-secondary); }
        .npb-time-bar { width: 100%; max-width: 400px; height: 4px; background: var(--border); border-radius: 2px; cursor: pointer; position: relative; }
        .npb-time-fill { height: 100%; background: var(--green); border-radius: 2px; width: 0%; position: relative; }
        .npb-time-fill::after {
            content: ''; position: absolute; right: -5px; top: -3px; width: 10px; height: 10px;
            background: var(--green); border-radius: 50%; opacity: 0; transition: opacity 0.15s;
        }
        .npb-time-bar:hover .npb-time-fill::after { opacity: 1; }
        .npb-right { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .npb-vol-slider {
            position: relative; width: 100px; height: 20px; cursor: pointer;
            display: flex; align-items: center;
        }
        .npb-vol-track {
            position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
            height: 3px; background: var(--border); border-radius: 2px;
        }
        .npb-vol-fill {
            height: 100%; background: var(--green); border-radius: 2px; width: 80%;
            transition: width 0.05s linear;
        }
        .npb-vol-dot {
            position: absolute; top: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--green); left: 80%;
            box-shadow: 0 0 6px rgba(0,0,0,0.15);
            transition: width 0.2s ease, height 0.2s ease, box-shadow 0.2s ease;
            pointer-events: none;
        }
        .npb-vol-slider.dragging .npb-vol-dot,
        .npb-vol-slider:hover .npb-vol-dot {
            width: 16px; height: 16px;
            box-shadow: 0 0 12px var(--green-glow);
        }
        .npb-vol-icon { width: 18px; height: 18px; fill: var(--text-secondary); cursor: pointer; }

        /* Creator Selector Overlay */
        .creator-selector-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .creator-selector-overlay.active { display: flex; }
        .creator-selector-box {
            background: var(--surface-solid); border-radius: 24px; padding: 40px 32px;
            max-width: 480px; width: 100%; max-height: 80vh; overflow-y: auto;
            box-shadow: var(--panel-glow);
        }
        .cs-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; color: var(--text); text-align: center; }
        .cs-desc { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.9rem; text-align: center; }
        .cs-list { display: flex; flex-direction: column; gap: 10px; }
        .cs-card {
            display: flex; align-items: center; gap: 14px; padding: 14px 16px;
            border-radius: 14px; border: 1px solid var(--border); cursor: pointer;
            background: var(--input-bg); transition: all 0.2s;
        }
        .cs-card:hover { border-color: var(--green); background: var(--track-hover); transform: translateY(-1px); }
        .cs-card-icon {
            width: 44px; height: 44px; border-radius: 50%;
            background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .cs-card-icon svg { width: 22px; height: 22px; fill: var(--green); }
        .cs-card-info h4 { font-size: 0.95rem; font-weight: 600; color: var(--text); }
        .cs-card-info p { font-size: 0.8rem; color: var(--text-secondary); }
        .cs-add-card {
            display: flex; align-items: center; gap: 14px; padding: 14px 16px;
            border-radius: 14px; border: 1px dashed var(--border); cursor: pointer;
            background: transparent; transition: all 0.2s;
        }
        .cs-add-card:hover { border-color: var(--green); background: var(--track-hover); }
        .cs-add-icon {
            width: 44px; height: 44px; border-radius: 50%;
            border: 2px dashed var(--border); display: flex; align-items: center;
            justify-content: center; flex-shrink: 0;
        }
        .cs-add-icon svg { width: 22px; height: 22px; fill: var(--text-secondary); }
        .cs-add-card span { color: var(--text-secondary); font-weight: 500; font-size: 0.95rem; }

        /* Add Creator sub-view inside selector */
        .cs-add-form { display: none; margin-top: 20px; }
        .cs-add-form.active { display: block; }
        .cs-add-input {
            width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px;
            font-size: 1.4rem; text-align: center; letter-spacing: 6px; font-family: monospace;
            background: var(--input-bg); color: var(--text); margin-bottom: 12px;
        }
        .cs-add-input:focus { outline: none; border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
        .cs-add-btn {
            width: 100%; padding: 14px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: opacity 0.2s;
        }
        .cs-add-btn:hover { opacity: 0.85; }
        .cs-add-error { color: var(--red); font-size: 0.85rem; margin-top: 8px; display: none; text-align: center; }
        .cs-close {
            display: block; margin-top: 16px; text-align: center; color: var(--text-secondary);
            text-decoration: none; font-size: 0.9rem; cursor: pointer;
        }

        /* Empty state */
        .empty-tracks { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-tracks svg { width: 64px; height: 64px; fill: var(--text-secondary); opacity: 0.2; margin-bottom: 16px; }

        /* Responsive */
        @media (max-width: 768px) {
            .player-header-left { margin-left: 48px; }
            .player-header-right { margin-right: 48px; }
            .hero-inner { flex-direction: column; align-items: center; text-align: center; gap: 24px; }
            .hero-art { width: 280px; height: 280px; }
            .hero-title { font-size: 1.8rem; }
            .track-table-header { display: none; }
            .track-row { grid-template-columns: 40px 48px 1fr; }
            .track-row .tr-duration { display: none; }
            .track-row .tr-art { width: 48px; height: 48px; }
            .npb-content { grid-template-columns: 1fr auto; }
            .npb-right { display: none; }
            .npb-center { gap: 4px; }
            .npb-times { display: none; }
        }
        @media (max-width: 480px) {
            .player-header-left h1 { font-size: 1rem; }
            .player-header-right { display: none; }
            .hero-section { padding: 32px 16px 24px; }
            .hero-art { width: 240px; height: 240px; border-radius: 16px; }
            .hero-title { font-size: 1.5rem; }
            .track-row { padding: 8px; gap: 10px; grid-template-columns: 32px 44px 1fr; }
            .track-row .tr-art { width: 44px; height: 44px; }
            .track-row .tr-info h4 { font-size: 0.9rem; }
            .npb-art { width: 40px; height: 40px; }
            .npb-controls { gap: 16px; }
            .npb-btn.npb-play { width: 36px; height: 36px; }
        }
    </style>
</head>
<body>
    <!-- Adaptive color background overlay -->
    <div class="adaptive-bg" id="adaptiveBg"></div>

    <a href="welcome.html" class="back-arrow" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </a>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>

    <!-- GATE -->
    <div class="gate-container" id="accessGate">
        <div class="gate-box">
            <div class="gate-icon">
                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <h2 class="shimmer-text">Enter Listener Key</h2>
            <p>Enter a creator's 4-digit key to listen to their music.</p>
            <form id="accessForm">
                <input type="text" id="listenerKeyInput" class="gate-input" placeholder="0000" required inputmode="numeric" pattern="[0-9]{4}" maxlength="4">
                <button type="submit" class="gate-btn">Unlock Music</button>
            </form>
            <div id="accessError" style="color:var(--red); margin-top:12px; display:none;"></div>
        </div>
    </div>

    <!-- CREATOR SELECTOR OVERLAY -->
    <div class="creator-selector-overlay" id="creatorSelector">
        <div class="creator-selector-box">
            <div class="cs-title">Your Creators</div>
            <div class="cs-desc">Choose a creator to listen to their music</div>
            <div class="cs-list" id="creatorList"></div>
            <div class="cs-add-form" id="csAddForm">
                <input type="text" class="cs-add-input" id="csAddKeyInput" placeholder="0000" inputmode="numeric" pattern="[0-9]{4}" maxlength="4">
                <button class="cs-add-btn" onclick="addCreatorByKey()">Unlock Creator</button>
                <div class="cs-add-error" id="csAddError"></div>
            </div>
            <a class="cs-close" id="csCloseBtn" onclick="closeCreatorSelector()">Cancel</a>
        </div>
    </div>

    <!-- PLAYER APP -->
    <div class="player-app" id="playerApp">
        <div class="player-header">
            <div class="player-header-left">
                <h1 id="headerTitle" class="shimmer-text">Alpha Channel Media</h1>
            </div>
            <div class="player-header-right">
                <a href="videos.html">Videos</a>
                <a href="#" onclick="showCreatorSelector(); return false;" id="switchCreatorLink">Switch Creator</a>
            </div>
        </div>

        <!-- Hero: large artwork + info -->
        <div class="hero-section">
            <div class="hero-inner">
                <div class="hero-art" id="heroArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="hero-info">
                    <div class="hero-type">Playlist</div>
                    <div class="hero-title shimmer-text" id="libraryTitle">Music Library</div>
                    <div class="hero-artist" id="libraryArtist"></div>
                    <div class="hero-meta" id="libraryMeta"></div>
                    <button class="play-all-btn" onclick="playAll()">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Play All
                    </button>
                    <br>
                    <a href="#" onclick="showCreatorSelector(); return false;" class="change-key-link">Switch Creator</a>
                </div>
            </div>
        </div>

        <div class="track-list-container">
            <div class="track-table">
                <div class="track-table-header">
                    <span>#</span>
                    <span></span>
                    <span>Title</span>
                    <span style="text-align:right;">Duration</span>
                </div>
                <div id="tracksList"></div>
            </div>
        </div>
    </div>

    <!-- NOW PLAYING BAR -->
    <div class="now-playing-bar" id="nowPlayingBar">
        <div class="npb-progress" id="npbProgressTop" onclick="seekFromBar(event, this)">
            <div class="npb-progress-fill" id="npbProgressTopFill"></div>
        </div>
        <div class="npb-content">
            <div class="npb-left">
                <div class="npb-art" id="npbArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="npb-track-info">
                    <h4 id="npbTitle">-</h4>
                    <p id="npbArtist">-</p>
                </div>
            </div>
            <div class="npb-center">
                <div class="npb-controls">
                    <button class="npb-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="prevTrack()" title="Previous">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button class="npb-btn npb-play" onclick="togglePlay()" id="mainPlayBtn" title="Play">
                        <svg viewBox="0 0 24 24" id="mainPlayIcon"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="nextTrack()" title="Next">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="toggleRepeat()" id="repeatBtn" title="Repeat">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    </button>
                </div>
                <div class="npb-times">
                    <span id="npbCurrentTime">0:00</span>
                    <div class="npb-time-bar" onclick="seekFromBar(event, this)">
                        <div class="npb-time-fill" id="npbTimeFill"></div>
                    </div>
                    <span id="npbDuration">0:00</span>
                </div>
            </div>
            <div class="npb-right">
                <svg class="npb-vol-icon" viewBox="0 0 24 24" onclick="toggleMute()"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <div class="npb-vol-slider" id="volSlider">
                    <div class="npb-vol-track"><div class="npb-vol-fill" id="volFill"></div></div>
                    <div class="npb-vol-dot" id="volDot"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        var API = window.location.origin;
        var audio = document.getElementById('audioPlayer');
        var tracks = [];
        var currentIndex = -1;
        var isPlaying = false;
        var shuffleOn = false;
        var repeatOn = false;
        var currentCreatorId = null;
        var unlockedCreators = []; // server-side persistent list

        // ===== ADAPTIVE COLOR EXTRACTION =====
        function extractColors(imgUrl) {
            if (!imgUrl) return;
            var img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var size = 50;
                canvas.width = size; canvas.height = size;
                ctx.drawImage(img, 0, 0, size, size);
                var data = ctx.getImageData(0, 0, size, size).data;

                // Sample colors from different quadrants
                var colors = { tl: [0,0,0], tr: [0,0,0], bl: [0,0,0], br: [0,0,0], center: [0,0,0] };
                var half = Math.floor(size / 2);
                var counts = { tl: 0, tr: 0, bl: 0, br: 0, center: 0 };

                for (var y = 0; y < size; y++) {
                    for (var x = 0; x < size; x++) {
                        var idx = (y * size + x) * 4;
                        var r = data[idx], g = data[idx+1], b = data[idx+2];
                        // Skip very dark or very light pixels
                        var brightness = (r + g + b) / 3;
                        if (brightness < 20 || brightness > 240) continue;

                        var region;
                        if (x < half && y < half) region = 'tl';
                        else if (x >= half && y < half) region = 'tr';
                        else if (x < half && y >= half) region = 'bl';
                        else region = 'br';

                        // Also sample center
                        if (x > size*0.25 && x < size*0.75 && y > size*0.25 && y < size*0.75) {
                            colors.center[0] += r; colors.center[1] += g; colors.center[2] += b;
                            counts.center++;
                        }

                        colors[region][0] += r; colors[region][1] += g; colors[region][2] += b;
                        counts[region]++;
                    }
                }

                // Average each region
                var avgColors = {};
                for (var key in colors) {
                    if (counts[key] > 0) {
                        avgColors[key] = [
                            Math.round(colors[key][0] / counts[key]),
                            Math.round(colors[key][1] / counts[key]),
                            Math.round(colors[key][2] / counts[key])
                        ];
                    } else {
                        avgColors[key] = [80, 80, 80];
                    }
                }

                // Pick two most vibrant/different colors
                var primary = avgColors.center;
                var secondary = avgColors.tl;

                // Find the most different color from primary
                var maxDist = 0;
                for (var k in avgColors) {
                    if (k === 'center') continue;
                    var d = Math.abs(avgColors[k][0] - primary[0]) +
                            Math.abs(avgColors[k][1] - primary[1]) +
                            Math.abs(avgColors[k][2] - primary[2]);
                    if (d > maxDist) { maxDist = d; secondary = avgColors[k]; }
                }

                applyAdaptiveColors(primary, secondary);
            };
            img.src = imgUrl;
        }

        function applyAdaptiveColors(primary, secondary) {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var bgEl = document.getElementById('adaptiveBg');

            // Set CSS variable for track highlighting
            document.documentElement.style.setProperty('--art-primary', primary.join(','));
            document.documentElement.style.setProperty('--art-secondary', secondary.join(','));

            // Build gradient overlay
            var pAlpha = isDark ? 0.25 : 0.12;
            var sAlpha = isDark ? 0.18 : 0.08;
            bgEl.style.background =
                'radial-gradient(ellipse at top left, rgba(' + primary.join(',') + ',' + pAlpha + ') 0%, transparent 60%), ' +
                'radial-gradient(ellipse at bottom right, rgba(' + secondary.join(',') + ',' + sAlpha + ') 0%, transparent 60%), ' +
                'radial-gradient(ellipse at center, rgba(' + primary.join(',') + ',' + (pAlpha * 0.4) + ') 0%, transparent 50%)';
            bgEl.classList.add('active');

            // Tint the hero art shadow
            var heroArt = document.getElementById('heroArt');
            heroArt.style.boxShadow = '0 16px 60px rgba(' + primary.join(',') + ',0.35), 0 8px 30px rgba(' + secondary.join(',') + ',0.2)';
        }

        // ===== INITIALIZATION — check for server-side access first =====
        (async function initAccess() {
            var token = localStorage.getItem('authToken');

            // Try server-side: fetch unlocked creators if we have a JWT
            if (token) {
                try {
                    var resp = await fetch(API + '/api/listeners/my-creators', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (resp.ok) {
                        var data = await resp.json();
                        if (data.creators && data.creators.length > 0) {
                            unlockedCreators = data.creators;
                            localStorage.setItem('unlockedCreators', JSON.stringify(unlockedCreators));

                            if (unlockedCreators.length === 1) {
                                // Single creator — auto-load
                                selectCreator(unlockedCreators[0]);
                                return;
                            } else {
                                // Multiple creators — check if we have a current selection
                                var savedId = localStorage.getItem('currentCreatorId');
                                var found = savedId && unlockedCreators.find(function(c) { return c.id === savedId; });
                                if (found) {
                                    selectCreator(found);
                                    return;
                                }
                                // No saved selection — show selector
                                showCreatorSelector();
                                return;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Server access check failed, falling back to localStorage');
                }
            }

            // Fallback: check localStorage (backwards compatible)
            var storedCreators = localStorage.getItem('unlockedCreators');
            if (storedCreators) {
                try {
                    unlockedCreators = JSON.parse(storedCreators);
                    if (unlockedCreators.length > 0) {
                        var savedId = localStorage.getItem('currentCreatorId');
                        var found = savedId && unlockedCreators.find(function(c) { return c.id === savedId; });
                        if (found) { selectCreator(found); return; }
                        if (unlockedCreators.length === 1) { selectCreator(unlockedCreators[0]); return; }
                        showCreatorSelector();
                        return;
                    }
                } catch (e) {}
            }

            // Final fallback: check old listenerKey localStorage
            var storedKey = localStorage.getItem('listenerKey');
            if (storedKey) { validateAndLoad(storedKey); return; }

            // No access at all — show gate
            document.getElementById('accessGate').style.display = 'flex';
        })();

        function selectCreator(creator) {
            currentCreatorId = creator.id;
            localStorage.setItem('currentCreatorId', creator.id);
            localStorage.setItem('currentCreatorName', creator.artist_name || creator.username);
            document.getElementById('accessGate').style.display = 'none';
            document.getElementById('creatorSelector').classList.remove('active');
            document.getElementById('playerApp').classList.add('active');
            var name = creator.artist_name || creator.first_name || creator.username;
            document.getElementById('headerTitle').textContent = name;
            document.getElementById('libraryTitle').textContent = name + "'s Music";
            document.getElementById('libraryArtist').textContent = name;
            loadTracks(currentCreatorId);
        }

        // ===== CREATOR SELECTOR =====
        function showCreatorSelector() {
            var list = document.getElementById('creatorList');
            list.innerHTML = '';
            document.getElementById('csAddForm').classList.remove('active');
            document.getElementById('csAddError').style.display = 'none';

            unlockedCreators.forEach(function(c) {
                var card = document.createElement('div');
                card.className = 'cs-card';
                card.onclick = function() { selectCreator(c); };
                var initial = (c.artist_name || c.username || '?').charAt(0).toUpperCase();
                card.innerHTML = '<div class="cs-card-icon"><svg viewBox="0 0 24 24"><text x="12" y="17" text-anchor="middle" font-size="14" font-weight="bold" fill="var(--green)">' + escapeHtml(initial) + '</text></svg></div>' +
                    '<div class="cs-card-info"><h4>' + escapeHtml(c.artist_name || c.username) + '</h4><p>' + escapeHtml((c.first_name || '') + ' ' + (c.last_name || '')).trim() + '</p></div>';
                list.appendChild(card);
            });

            // Add "Add Another Creator" card
            var addCard = document.createElement('div');
            addCard.className = 'cs-add-card';
            addCard.onclick = function() {
                document.getElementById('csAddForm').classList.add('active');
                document.getElementById('csAddKeyInput').focus();
            };
            addCard.innerHTML = '<div class="cs-add-icon"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></div><span>Add Another Creator</span>';
            list.appendChild(addCard);

            // Show/hide close button based on whether player is already active
            document.getElementById('csCloseBtn').style.display = document.getElementById('playerApp').classList.contains('active') ? 'block' : 'none';
            document.getElementById('creatorSelector').classList.add('active');
        }

        function closeCreatorSelector() {
            document.getElementById('creatorSelector').classList.remove('active');
        }

        async function addCreatorByKey() {
            var key = document.getElementById('csAddKeyInput').value.trim();
            var errEl = document.getElementById('csAddError');
            errEl.style.display = 'none';
            if (!/^\d{4}$/.test(key)) {
                errEl.textContent = 'Enter a valid 4-digit key.';
                errEl.style.display = 'block';
                return;
            }
            try {
                var token = localStorage.getItem('authToken');
                var headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;

                var response = await fetch(API + '/api/listener-key/validate', {
                    method: 'POST', headers: headers,
                    body: JSON.stringify({ listener_key: key })
                });
                var data = await response.json();
                if (response.ok && data.success) {
                    localStorage.setItem('listenerKey', key);
                    var creator = data.creator;
                    // Add to local list if not already there
                    if (!unlockedCreators.find(function(c) { return c.id === creator.id; })) {
                        unlockedCreators.push(creator);
                        localStorage.setItem('unlockedCreators', JSON.stringify(unlockedCreators));
                    }
                    selectCreator(creator);
                } else {
                    errEl.textContent = 'Invalid listener key. Please try again.';
                    errEl.style.display = 'block';
                }
            } catch (err) {
                errEl.textContent = 'Error validating key.';
                errEl.style.display = 'block';
            }
        }

        // Gate form (fallback for non-authenticated users)
        document.getElementById('accessForm').addEventListener('submit', function(e) {
            e.preventDefault();
            validateAndLoad(document.getElementById('listenerKeyInput').value.trim());
        });

        async function validateAndLoad(key) {
            try {
                var token = localStorage.getItem('authToken');
                var headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;

                var response = await fetch(API + '/api/listener-key/validate', {
                    method: 'POST', headers: headers,
                    body: JSON.stringify({ listener_key: key })
                });
                var data = await response.json();
                if (response.ok && data.success) {
                    currentCreatorId = data.creator.id;
                    localStorage.setItem('listenerKey', key);
                    localStorage.setItem('currentCreatorId', data.creator.id);
                    localStorage.setItem('currentCreatorName', data.creator.artist_name || data.creator.username);
                    // Add to unlocked creators if not there
                    if (!unlockedCreators.find(function(c) { return c.id === data.creator.id; })) {
                        unlockedCreators.push(data.creator);
                        localStorage.setItem('unlockedCreators', JSON.stringify(unlockedCreators));
                    }
                    document.getElementById('accessGate').style.display = 'none';
                    document.getElementById('playerApp').classList.add('active');
                    var name = data.creator.artist_name || data.creator.first_name;
                    document.getElementById('headerTitle').textContent = name;
                    document.getElementById('libraryTitle').textContent = name + "'s Music";
                    document.getElementById('libraryArtist').textContent = name;
                    loadTracks(currentCreatorId);
                } else {
                    document.getElementById('accessError').textContent = 'Invalid listener key';
                    document.getElementById('accessError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('accessError').textContent = 'Error validating key';
                document.getElementById('accessError').style.display = 'block';
            }
        }

        function clearListenerKey() {
            localStorage.removeItem('listenerKey');
            localStorage.removeItem('currentCreatorId');
            localStorage.removeItem('currentCreatorName');
            currentCreatorId = null;
            audio.pause(); audio.src = '';
            document.getElementById('nowPlayingBar').classList.remove('active');
            document.getElementById('playerApp').classList.remove('active');
            document.getElementById('accessGate').style.display = 'flex';
            document.getElementById('tracksList').innerHTML = '';
            document.getElementById('listenerKeyInput').value = '';
            document.getElementById('accessError').style.display = 'none';
            document.getElementById('adaptiveBg').classList.remove('active');
            tracks = []; currentIndex = -1;
        }

        async function loadTracks(creatorId) {
            try {
                var url = creatorId ? API + '/api/tracks?creator_id=' + creatorId : API + '/api/tracks';
                var response = await fetch(url);
                var data = await response.json();
                tracks = data.tracks || [];
                document.getElementById('libraryMeta').textContent = tracks.length + ' track' + (tracks.length !== 1 ? 's' : '');

                // Set hero art to first track's artwork if available
                if (tracks.length > 0 && tracks[0].artwork_url) {
                    document.getElementById('heroArt').innerHTML = '<img src="' + tracks[0].artwork_url + '">';
                    extractColors(tracks[0].artwork_url);
                }

                renderTracks();
            } catch (err) {
                console.error('Error loading tracks:', err);
            }
        }

        function renderTracks() {
            var list = document.getElementById('tracksList');
            if (tracks.length === 0) {
                list.innerHTML = '<div class="empty-tracks"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No tracks uploaded yet.</p></div>';
                return;
            }
            list.innerHTML = '';
            tracks.forEach(function(track, i) {
                var row = document.createElement('div');
                row.className = 'track-row' + (i === currentIndex ? ' active' : '');
                row.onclick = function() { playTrack(i); };
                var artHtml = track.artwork_url
                    ? '<img src="' + track.artwork_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                row.innerHTML = '<div class="tr-num">' + (i + 1) + '</div>' +
                    '<div class="tr-art">' + artHtml + '</div>' +
                    '<div class="tr-info"><h4>' + escapeHtml(track.title) + '</h4><p>' + escapeHtml(track.artist) + '</p></div>' +
                    '<div class="tr-duration" id="dur-' + i + '">--:--</div>';
                list.appendChild(row);
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= tracks.length) return;
            currentIndex = index;
            var track = tracks[index];
            audio.src = track.audio_url;
            audio.play();

            // Update now playing bar
            document.getElementById('nowPlayingBar').classList.add('active');
            document.getElementById('npbTitle').textContent = track.title;
            document.getElementById('npbArtist').textContent = track.artist;
            if (track.artwork_url) {
                document.getElementById('npbArt').innerHTML = '<img src="' + track.artwork_url + '">';
                // Update hero art and extract colors for this track
                document.getElementById('heroArt').innerHTML = '<img src="' + track.artwork_url + '">';
                extractColors(track.artwork_url);
            } else {
                document.getElementById('npbArt').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
            }

            // Highlight active row
            document.querySelectorAll('.track-row').forEach(function(r, i) {
                r.classList.toggle('active', i === index);
            });
        }

        function playAll() {
            if (tracks.length > 0) playTrack(0);
        }

        function togglePlay() {
            if (currentIndex === -1 && tracks.length > 0) { playTrack(0); return; }
            if (isPlaying) audio.pause();
            else audio.play();
        }

        function nextTrack() {
            if (tracks.length === 0) return;
            var next = shuffleOn ? Math.floor(Math.random() * tracks.length) : currentIndex + 1;
            if (next >= tracks.length) next = 0;
            playTrack(next);
        }

        function prevTrack() {
            if (tracks.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            var prev = currentIndex - 1;
            if (prev < 0) prev = tracks.length - 1;
            playTrack(prev);
        }

        function toggleShuffle() {
            shuffleOn = !shuffleOn;
            document.getElementById('shuffleBtn').classList.toggle('active-mode', shuffleOn);
        }

        function toggleRepeat() {
            repeatOn = !repeatOn;
            document.getElementById('repeatBtn').classList.toggle('active-mode', repeatOn);
        }

        // ===== CUSTOM VOLUME SLIDER =====
        var volSlider = document.getElementById('volSlider');
        var volFill = document.getElementById('volFill');
        var volDot = document.getElementById('volDot');
        var volDragging = false;
        var currentVol = 80;
        var prevVol = 80;

        function setVolume(val) {
            currentVol = Math.max(0, Math.min(100, val));
            audio.volume = currentVol / 100;
            volFill.style.width = currentVol + '%';
            volDot.style.left = currentVol + '%';
            // Scale dot: 10px at 0%, 16px at 100%
            var dotSize = 10 + (currentVol / 100) * 6;
            volDot.style.width = dotSize + 'px';
            volDot.style.height = dotSize + 'px';
        }

        function volFromEvent(e) {
            var rect = volSlider.getBoundingClientRect();
            var pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
            setVolume(pct);
        }

        volSlider.addEventListener('mousedown', function(e) {
            volDragging = true;
            volSlider.classList.add('dragging');
            volFromEvent(e);
            e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (volDragging) volFromEvent(e);
        });
        document.addEventListener('mouseup', function() {
            if (volDragging) { volDragging = false; volSlider.classList.remove('dragging'); }
        });
        // Touch support
        volSlider.addEventListener('touchstart', function(e) {
            volDragging = true;
            volSlider.classList.add('dragging');
            volFromEvent(e.touches[0]);
            e.preventDefault();
        }, { passive: false });
        document.addEventListener('touchmove', function(e) {
            if (volDragging) volFromEvent(e.touches[0]);
        });
        document.addEventListener('touchend', function() {
            if (volDragging) { volDragging = false; volSlider.classList.remove('dragging'); }
        });

        function toggleMute() {
            if (currentVol > 0) { prevVol = currentVol; setVolume(0); }
            else { setVolume(prevVol || 80); }
        }

        // Initialize volume display
        setVolume(80);

        function seekFromBar(e, bar) {
            if (!audio.duration) return;
            var rect = bar.getBoundingClientRect();
            var pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.currentTime = pct * audio.duration;
        }

        // Audio events
        audio.addEventListener('play', function() {
            isPlaying = true;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        });
        audio.addEventListener('pause', function() {
            isPlaying = false;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
        });
        audio.addEventListener('timeupdate', function() {
            if (!audio.duration) return;
            var pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('npbProgressTopFill').style.width = pct + '%';
            document.getElementById('npbTimeFill').style.width = pct + '%';
            document.getElementById('npbCurrentTime').textContent = formatTime(audio.currentTime);
            document.getElementById('npbDuration').textContent = formatTime(audio.duration);
        });
        audio.addEventListener('loadedmetadata', function() {
            if (currentIndex >= 0) {
                var durEl = document.getElementById('dur-' + currentIndex);
                if (durEl) durEl.textContent = formatTime(audio.duration);
            }
        });
        audio.addEventListener('ended', function() {
            if (repeatOn) { audio.currentTime = 0; audio.play(); }
            else nextTrack();
        });

        function formatTime(s) {
            if (isNaN(s)) return '--:--';
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Theme
        function toggleTheme() {
            var html = document.documentElement;
            var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next); localStorage.setItem('theme', next);
            // Re-apply adaptive colors if a track is playing
            if (currentIndex >= 0 && tracks[currentIndex] && tracks[currentIndex].artwork_url) {
                extractColors(tracks[currentIndex].artwork_url);
            }
        }
        (function() {
            var saved = localStorage.getItem('theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
</body>
</html>
