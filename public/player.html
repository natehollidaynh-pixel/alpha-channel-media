<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - Alpha Channel Media</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f5f5f5; --surface: rgba(255,255,255,0.6); --surface-solid: #ffffff;
            --green: #006e45; --green-glow: rgba(0,110,69,0.25); --red: #a12020; --red-glow: rgba(161,32,32,0.2);
            --text: #111111; --text-secondary: #555555; --border: rgba(0,0,0,0.08);
            --panel-glow: 0 0 30px rgba(0,110,69,0.12), 0 0 60px rgba(161,32,32,0.08);
            --panel-border: rgba(0,0,0,0.06); --input-bg: rgba(255,255,255,0.7);
            --track-hover: rgba(0,110,69,0.06);
        }
        [data-theme="dark"] {
            --bg: #0e0e0e; --surface: rgba(30,30,30,0.7); --surface-solid: #1a1a1a;
            --green: #00c97a; --green-glow: rgba(0,201,122,0.2); --red: #e04545; --red-glow: rgba(224,69,69,0.15);
            --text: #eaeaea; --text-secondary: #999999; --border: rgba(255,255,255,0.08);
            --panel-glow: 0 0 40px rgba(0,201,122,0.1), 0 0 80px rgba(224,69,69,0.06);
            --panel-border: rgba(255,255,255,0.06); --input-bg: rgba(40,40,40,0.7);
            --track-hover: rgba(0,201,122,0.06);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 0; }
        .back-arrow {
            position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            backdrop-filter: blur(10px); text-decoration: none; transition: all 0.3s;
        }
        .back-arrow:hover { box-shadow: var(--panel-glow); }
        .back-arrow svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .theme-toggle {
            position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            backdrop-filter: blur(10px); transition: all 0.3s;
        }
        .theme-toggle:hover { box-shadow: var(--panel-glow); }
        .theme-toggle svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .theme-toggle .icon-sun { display: none; }
        [data-theme="dark"] .theme-toggle .icon-moon { display: none; }
        [data-theme="dark"] .theme-toggle .icon-sun { display: block; }

        /* Gate */
        .gate-container {
            display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;
        }
        .gate-box {
            max-width: 440px; width: 100%; background: var(--surface); backdrop-filter: blur(25px);
            border-radius: 24px; border: 1px solid var(--panel-border); box-shadow: var(--panel-glow);
            padding: 48px 36px; text-align: center;
        }
        .gate-icon { margin-bottom: 20px; }
        .gate-icon svg { width: 56px; height: 56px; fill: var(--green); opacity: 0.7; }
        .gate-box h2 { margin-bottom: 8px; color: var(--text); font-size: 1.5rem; }
        .gate-box p { color: var(--text-secondary); margin-bottom: 28px; font-size: 0.95rem; }
        .gate-input {
            width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 12px;
            margin-bottom: 16px; font-size: 1.8rem; text-align: center; letter-spacing: 10px;
            font-family: monospace; background: var(--input-bg); color: var(--text); font-weight: 600;
        }
        .gate-input:focus { outline: none; border-color: var(--green); box-shadow: 0 0 0 3px var(--green-glow); }
        .gate-btn {
            width: 100%; padding: 16px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: opacity 0.2s;
        }
        .gate-btn:hover { opacity: 0.85; }

        /* Main player layout */
        .player-app { display: none; min-height: 100vh; padding-bottom: 160px; }
        .player-app.active { display: block; }

        /* Header bar */
        .player-header {
            position: sticky; top: 0; z-index: 100; background: var(--surface-solid);
            backdrop-filter: blur(25px); border-bottom: 1px solid var(--border);
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            max-width: 100%;
        }
        .player-header-left { display: flex; align-items: center; gap: 12px; margin-left: 40px; }
        .player-header-left h1 { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .player-header-right { display: flex; align-items: center; gap: 16px; margin-right: 40px; }
        .player-header-right a { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .player-header-right a:hover { color: var(--green); }

        /* Track list */
        .track-list-container { max-width: 900px; margin: 0 auto; padding: 24px 20px; }
        .track-list-header {
            display: flex; align-items: flex-end; gap: 28px; margin-bottom: 32px;
            padding: 0 0 24px; border-bottom: 1px solid var(--border);
        }
        .tlh-art {
            width: 180px; height: 180px; border-radius: 16px; background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .tlh-art img { width: 100%; height: 100%; object-fit: cover; }
        .tlh-art svg { width: 64px; height: 64px; fill: var(--text-secondary); opacity: 0.3; }
        .tlh-info { flex: 1; }
        .tlh-type { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 8px; }
        .tlh-title { font-size: 2rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .tlh-artist { font-size: 1rem; color: var(--green); font-weight: 500; margin-bottom: 12px; }
        .tlh-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .play-all-btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 12px 28px;
            background: var(--green); color: white; border: none; border-radius: 24px;
            font-weight: 600; font-size: 0.95rem; cursor: pointer; margin-top: 16px; transition: all 0.2s;
        }
        .play-all-btn:hover { opacity: 0.85; transform: scale(1.02); }
        .play-all-btn svg { width: 18px; height: 18px; fill: white; }
        .change-key-link {
            display: inline-block; margin-top: 8px; color: var(--text-secondary);
            text-decoration: none; font-size: 0.85rem;
        }
        .change-key-link:hover { color: var(--green); }

        /* Track rows */
        .track-table { width: 100%; }
        .track-table-header {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 8px 12px; border-bottom: 1px solid var(--border);
            color: var(--text-secondary); font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .track-row {
            display: grid; grid-template-columns: 40px 56px 1fr 80px;
            gap: 12px; padding: 10px 12px; border-radius: 10px; cursor: pointer;
            align-items: center; transition: background 0.15s;
        }
        .track-row:hover { background: var(--track-hover); }
        .track-row.active { background: var(--green-glow); }
        .track-row .tr-num { text-align: center; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
        .track-row.active .tr-num { color: var(--green); }
        .track-row .tr-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .track-row .tr-art img { width: 100%; height: 100%; object-fit: cover; }
        .track-row .tr-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .track-row .tr-info { min-width: 0; }
        .track-row .tr-info h4 {
            font-size: 0.95rem; font-weight: 500; color: var(--text); margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-row.active .tr-info h4 { color: var(--green); }
        .track-row .tr-info p { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-row .tr-duration { font-size: 0.85rem; color: var(--text-secondary); text-align: right; }

        /* Now Playing Bar (fixed bottom) */
        .now-playing-bar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
            background: var(--surface-solid); border-top: 1px solid var(--border);
            backdrop-filter: blur(25px); display: none;
        }
        .now-playing-bar.active { display: block; }
        .npb-progress {
            width: 100%; height: 3px; background: var(--border); cursor: pointer; position: relative;
        }
        .npb-progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.15s linear; }
        .npb-content {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px;
            padding: 10px 20px; padding-bottom: max(10px, env(safe-area-inset-bottom));
            align-items: center; max-width: 1200px; margin: 0 auto;
        }
        .npb-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
        .npb-art {
            width: 48px; height: 48px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
        }
        .npb-art img { width: 100%; height: 100%; object-fit: cover; }
        .npb-art svg { width: 20px; height: 20px; fill: var(--text-secondary); opacity: 0.4; }
        .npb-track-info { min-width: 0; }
        .npb-track-info h4 { font-size: 0.9rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-track-info p { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .npb-center { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .npb-controls { display: flex; align-items: center; gap: 20px; }
        .npb-btn {
            background: none; border: none; cursor: pointer; padding: 6px; display: flex;
            align-items: center; justify-content: center; transition: transform 0.15s;
        }
        .npb-btn:hover { transform: scale(1.1); }
        .npb-btn:active { transform: scale(0.95); }
        .npb-btn svg { fill: var(--text); }
        .npb-btn.npb-play {
            width: 40px; height: 40px; background: var(--green); border-radius: 50%;
        }
        .npb-btn.npb-play svg { fill: white; width: 18px; height: 18px; }
        .npb-btn.active-mode svg { fill: var(--green); }
        .npb-times { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-secondary); }
        .npb-time-bar { width: 100%; max-width: 400px; height: 4px; background: var(--border); border-radius: 2px; cursor: pointer; position: relative; }
        .npb-time-fill { height: 100%; background: var(--green); border-radius: 2px; width: 0%; position: relative; }
        .npb-time-fill::after {
            content: ''; position: absolute; right: -5px; top: -3px; width: 10px; height: 10px;
            background: var(--green); border-radius: 50%; opacity: 0; transition: opacity 0.15s;
        }
        .npb-time-bar:hover .npb-time-fill::after { opacity: 1; }
        .npb-right { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .npb-vol-slider {
            -webkit-appearance: none; appearance: none; width: 100px; height: 4px;
            background: var(--border); border-radius: 2px; outline: none;
        }
        .npb-vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: var(--green); cursor: pointer;
        }
        .npb-vol-icon { width: 18px; height: 18px; fill: var(--text-secondary); }

        /* Empty state */
        .empty-tracks { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-tracks svg { width: 64px; height: 64px; fill: var(--text-secondary); opacity: 0.2; margin-bottom: 16px; }

        /* Responsive */
        @media (max-width: 768px) {
            .player-header-left { margin-left: 48px; }
            .player-header-right { margin-right: 48px; }
            .track-list-header { flex-direction: column; align-items: center; text-align: center; gap: 20px; }
            .tlh-art { width: 200px; height: 200px; }
            .tlh-title { font-size: 1.5rem; }
            .track-table-header { display: none; }
            .track-row { grid-template-columns: 40px 48px 1fr; }
            .track-row .tr-duration { display: none; }
            .track-row .tr-art { width: 48px; height: 48px; }
            .npb-content { grid-template-columns: 1fr auto; }
            .npb-right { display: none; }
            .npb-center { gap: 4px; }
            .npb-times { display: none; }
        }
        @media (max-width: 480px) {
            .player-header-left h1 { font-size: 1rem; }
            .player-header-right { display: none; }
            .tlh-art { width: 160px; height: 160px; border-radius: 12px; }
            .tlh-title { font-size: 1.3rem; }
            .track-row { padding: 8px; gap: 10px; grid-template-columns: 32px 44px 1fr; }
            .track-row .tr-art { width: 44px; height: 44px; }
            .track-row .tr-info h4 { font-size: 0.9rem; }
            .npb-art { width: 40px; height: 40px; }
            .npb-controls { gap: 16px; }
            .npb-btn.npb-play { width: 36px; height: 36px; }
        }
    </style>
</head>
<body>
    <a href="welcome.html" class="back-arrow" aria-label="Back">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </a>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    </button>

    <!-- GATE -->
    <div class="gate-container" id="accessGate">
        <div class="gate-box">
            <div class="gate-icon">
                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <h2>Enter Listener Key</h2>
            <p>Enter a creator's 4-digit key to listen to their music.</p>
            <form id="accessForm">
                <input type="text" id="listenerKeyInput" class="gate-input" placeholder="0000" required inputmode="numeric" pattern="[0-9]{4}" maxlength="4">
                <button type="submit" class="gate-btn">Unlock Music</button>
            </form>
            <div id="accessError" style="color:var(--red); margin-top:12px; display:none;"></div>
        </div>
    </div>

    <!-- PLAYER APP -->
    <div class="player-app" id="playerApp">
        <div class="player-header">
            <div class="player-header-left">
                <h1 id="headerTitle">Alpha Channel Media</h1>
            </div>
            <div class="player-header-right">
                <a href="videos.html">Videos</a>
                <a href="#" onclick="clearListenerKey(); return false;">Change Key</a>
            </div>
        </div>

        <div class="track-list-container">
            <div class="track-list-header">
                <div class="tlh-art" id="tlhArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="tlh-info">
                    <div class="tlh-type">Playlist</div>
                    <div class="tlh-title" id="libraryTitle">Music Library</div>
                    <div class="tlh-artist" id="libraryArtist"></div>
                    <div class="tlh-meta" id="libraryMeta"></div>
                    <button class="play-all-btn" onclick="playAll()">
                        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        Play All
                    </button>
                    <br>
                    <a href="#" onclick="clearListenerKey(); return false;" class="change-key-link">Change key</a>
                </div>
            </div>

            <div class="track-table">
                <div class="track-table-header">
                    <span>#</span>
                    <span></span>
                    <span>Title</span>
                    <span style="text-align:right;">Duration</span>
                </div>
                <div id="tracksList"></div>
            </div>
        </div>
    </div>

    <!-- NOW PLAYING BAR -->
    <div class="now-playing-bar" id="nowPlayingBar">
        <div class="npb-progress" id="npbProgressTop" onclick="seekFromBar(event, this)">
            <div class="npb-progress-fill" id="npbProgressTopFill"></div>
        </div>
        <div class="npb-content">
            <div class="npb-left">
                <div class="npb-art" id="npbArt">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="npb-track-info">
                    <h4 id="npbTitle">-</h4>
                    <p id="npbArtist">-</p>
                </div>
            </div>
            <div class="npb-center">
                <div class="npb-controls">
                    <button class="npb-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="prevTrack()" title="Previous">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button class="npb-btn npb-play" onclick="togglePlay()" id="mainPlayBtn" title="Play">
                        <svg viewBox="0 0 24 24" id="mainPlayIcon"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="nextTrack()" title="Next">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                    <button class="npb-btn" onclick="toggleRepeat()" id="repeatBtn" title="Repeat">
                        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    </button>
                </div>
                <div class="npb-times">
                    <span id="npbCurrentTime">0:00</span>
                    <div class="npb-time-bar" onclick="seekFromBar(event, this)">
                        <div class="npb-time-fill" id="npbTimeFill"></div>
                    </div>
                    <span id="npbDuration">0:00</span>
                </div>
            </div>
            <div class="npb-right">
                <svg class="npb-vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input type="range" class="npb-vol-slider" min="0" max="100" value="80" oninput="setVolume(this.value)">
            </div>
        </div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        var API = window.location.origin;
        var audio = document.getElementById('audioPlayer');
        var tracks = [];
        var currentIndex = -1;
        var isPlaying = false;
        var shuffleOn = false;
        var repeatOn = false;
        var currentCreatorId = null;

        // Check stored key
        var storedKey = localStorage.getItem('listenerKey');
        if (storedKey) validateAndLoad(storedKey);

        document.getElementById('accessForm').addEventListener('submit', function(e) {
            e.preventDefault();
            validateAndLoad(document.getElementById('listenerKeyInput').value.trim());
        });

        async function validateAndLoad(key) {
            try {
                var response = await fetch(API + '/api/listener-key/validate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ listener_key: key })
                });
                var data = await response.json();
                if (response.ok && data.success) {
                    currentCreatorId = data.creator.id;
                    localStorage.setItem('listenerKey', key);
                    document.getElementById('accessGate').style.display = 'none';
                    document.getElementById('playerApp').classList.add('active');
                    var name = data.creator.artist_name || data.creator.first_name;
                    document.getElementById('headerTitle').textContent = name;
                    document.getElementById('libraryTitle').textContent = name + "'s Music";
                    document.getElementById('libraryArtist').textContent = name;
                    loadTracks(currentCreatorId);
                } else {
                    document.getElementById('accessError').textContent = 'Invalid listener key';
                    document.getElementById('accessError').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('accessError').textContent = 'Error validating key';
                document.getElementById('accessError').style.display = 'block';
            }
        }

        function clearListenerKey() {
            localStorage.removeItem('listenerKey'); currentCreatorId = null;
            audio.pause(); audio.src = '';
            document.getElementById('nowPlayingBar').classList.remove('active');
            document.getElementById('playerApp').classList.remove('active');
            document.getElementById('accessGate').style.display = 'flex';
            document.getElementById('tracksList').innerHTML = '';
            document.getElementById('listenerKeyInput').value = '';
            document.getElementById('accessError').style.display = 'none';
            tracks = []; currentIndex = -1;
        }

        async function loadTracks(creatorId) {
            try {
                var url = creatorId ? API + '/api/tracks?creator_id=' + creatorId : API + '/api/tracks';
                var response = await fetch(url);
                var data = await response.json();
                tracks = data.tracks || [];
                document.getElementById('libraryMeta').textContent = tracks.length + ' track' + (tracks.length !== 1 ? 's' : '');

                // Set header art to first track's artwork if available
                if (tracks.length > 0 && tracks[0].artwork_url) {
                    document.getElementById('tlhArt').innerHTML = '<img src="' + tracks[0].artwork_url + '">';
                }

                renderTracks();
            } catch (err) {
                console.error('Error loading tracks:', err);
            }
        }

        function renderTracks() {
            var list = document.getElementById('tracksList');
            if (tracks.length === 0) {
                list.innerHTML = '<div class="empty-tracks"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No tracks uploaded yet.</p></div>';
                return;
            }
            list.innerHTML = '';
            tracks.forEach(function(track, i) {
                var row = document.createElement('div');
                row.className = 'track-row' + (i === currentIndex ? ' active' : '');
                row.onclick = function() { playTrack(i); };
                var artHtml = track.artwork_url
                    ? '<img src="' + track.artwork_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                row.innerHTML = '<div class="tr-num">' + (i + 1) + '</div>' +
                    '<div class="tr-art">' + artHtml + '</div>' +
                    '<div class="tr-info"><h4>' + escapeHtml(track.title) + '</h4><p>' + escapeHtml(track.artist) + '</p></div>' +
                    '<div class="tr-duration" id="dur-' + i + '">--:--</div>';
                list.appendChild(row);
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= tracks.length) return;
            currentIndex = index;
            var track = tracks[index];
            audio.src = track.audio_url;
            audio.play();

            // Update now playing bar
            document.getElementById('nowPlayingBar').classList.add('active');
            document.getElementById('npbTitle').textContent = track.title;
            document.getElementById('npbArtist').textContent = track.artist;
            if (track.artwork_url) {
                document.getElementById('npbArt').innerHTML = '<img src="' + track.artwork_url + '">';
            } else {
                document.getElementById('npbArt').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
            }

            // Highlight active row
            document.querySelectorAll('.track-row').forEach(function(r, i) {
                r.classList.toggle('active', i === index);
            });
        }

        function playAll() {
            if (tracks.length > 0) playTrack(0);
        }

        function togglePlay() {
            if (currentIndex === -1 && tracks.length > 0) { playTrack(0); return; }
            if (isPlaying) audio.pause();
            else audio.play();
        }

        function nextTrack() {
            if (tracks.length === 0) return;
            var next = shuffleOn ? Math.floor(Math.random() * tracks.length) : currentIndex + 1;
            if (next >= tracks.length) next = 0;
            playTrack(next);
        }

        function prevTrack() {
            if (tracks.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            var prev = currentIndex - 1;
            if (prev < 0) prev = tracks.length - 1;
            playTrack(prev);
        }

        function toggleShuffle() {
            shuffleOn = !shuffleOn;
            document.getElementById('shuffleBtn').classList.toggle('active-mode', shuffleOn);
        }

        function toggleRepeat() {
            repeatOn = !repeatOn;
            document.getElementById('repeatBtn').classList.toggle('active-mode', repeatOn);
        }

        function setVolume(val) { audio.volume = val / 100; }

        function seekFromBar(e, bar) {
            if (!audio.duration) return;
            var rect = bar.getBoundingClientRect();
            var pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            audio.currentTime = pct * audio.duration;
        }

        // Audio events
        audio.addEventListener('play', function() {
            isPlaying = true;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        });
        audio.addEventListener('pause', function() {
            isPlaying = false;
            document.getElementById('mainPlayIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
        });
        audio.addEventListener('timeupdate', function() {
            if (!audio.duration) return;
            var pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('npbProgressTopFill').style.width = pct + '%';
            document.getElementById('npbTimeFill').style.width = pct + '%';
            document.getElementById('npbCurrentTime').textContent = formatTime(audio.currentTime);
            document.getElementById('npbDuration').textContent = formatTime(audio.duration);
        });
        audio.addEventListener('loadedmetadata', function() {
            if (currentIndex >= 0) {
                var durEl = document.getElementById('dur-' + currentIndex);
                if (durEl) durEl.textContent = formatTime(audio.duration);
            }
        });
        audio.addEventListener('ended', function() {
            if (repeatOn) { audio.currentTime = 0; audio.play(); }
            else nextTrack();
        });

        function formatTime(s) {
            if (isNaN(s)) return '--:--';
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Theme
        function toggleTheme() {
            var html = document.documentElement;
            var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next); localStorage.setItem('theme', next);
        }
        (function() {
            var saved = localStorage.getItem('theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
        })();
    </script>
</body>
</html>
