<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Dashboard - Alpha Channel Media</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f0ede8;
            --bg-glossy: linear-gradient(135deg, #f5f2ed 0%, #faf8f5 20%, #f0ede8 40%, #fdf5f5 60%, #f0f7f3 80%, #f5f2ed 100%);
            --surface: rgba(255,255,255,0.55); --surface-solid: #ffffff;
            --green: #006e45; --green-glow: rgba(0,110,69,0.25); --red: #b82e2e; --red-glow: rgba(184,46,46,0.2);
            --text: #111111; --text-secondary: #555555; --border: rgba(0,0,0,0.08);
            --panel-glow: 0 0 30px rgba(0,110,69,0.12), 0 0 60px rgba(184,46,46,0.08);
            --panel-border: rgba(0,0,0,0.06); --input-bg: rgba(255,255,255,0.7);
            --shimmer-color: rgba(0,110,69,0.15);
        }
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-glossy: linear-gradient(135deg, #0e0e0e 0%, #121210 20%, #0e100e 40%, #140e0e 60%, #0e1210 80%, #0e0e0e 100%);
            --surface: rgba(25,25,25,0.7); --surface-solid: #141414;
            --green: #00c97a; --green-glow: rgba(0,201,122,0.2); --red: #e04545; --red-glow: rgba(224,69,69,0.15);
            --text: #eaeaea; --text-secondary: #999999; --border: rgba(255,255,255,0.08);
            --panel-glow: 0 0 40px rgba(0,201,122,0.1), 0 0 80px rgba(224,69,69,0.06);
            --panel-border: rgba(255,255,255,0.06); --input-bg: rgba(40,40,40,0.7);
            --shimmer-color: rgba(0,201,122,0.2);
        }
        .shimmer-text {
            background: linear-gradient(120deg, var(--text) 0%, var(--text) 40%, var(--shimmer-color) 50%, var(--text) 60%, var(--text) 100%);
            background-size: 200% 100%;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-glossy); background-attachment: fixed;
            color: var(--text); min-height: 100vh; padding: 20px; padding-bottom: 100px;
            position: relative; overflow-x: hidden;
        }
        body::before, body::after {
            content: ''; position: fixed; border-radius: 50%;
            filter: blur(80px); opacity: 0.4; pointer-events: none; z-index: 0;
        }
        body::before { width: 500px; height: 500px; background: radial-gradient(circle, rgba(0,150,80,0.2), transparent 70%); top: -100px; right: -100px; }
        body::after { width: 400px; height: 400px; background: radial-gradient(circle, rgba(200,40,40,0.15), transparent 70%); bottom: -50px; left: -50px; }
        .back-arrow {
            position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(10px); text-decoration: none; transition: all 0.3s;
        }
        .back-arrow:hover { box-shadow: var(--panel-glow); }
        .back-arrow svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .header {
            position: relative; z-index: 1; max-width: 1200px; margin: 0 auto 40px; padding: 20px;
            background: var(--surface); backdrop-filter: blur(25px); border-radius: 20px;
            border: 1px solid var(--panel-border); box-shadow: var(--panel-glow);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.4rem; font-weight: 600; margin-left: 40px; }
        nav a { color: var(--text-secondary); text-decoration: none; margin-left: 24px; font-weight: 500; }
        nav a:hover { color: var(--green); }
        .container { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; gap: 8px; margin-bottom: 32px; flex-wrap: wrap; }
        .tab {
            padding: 10px 20px; background: var(--surface); border: 1px solid var(--panel-border);
            border-radius: 12px; cursor: pointer; font-weight: 500; font-size: 0.9rem;
            -webkit-tap-highlight-color: transparent; color: var(--text); transition: all 0.2s;
        }
        .tab.active { background: var(--green); color: white; border-color: var(--green); }
        .tab-section {
            background: var(--surface); backdrop-filter: blur(10px); border-radius: 20px;
            border: 1px solid var(--panel-border); box-shadow: var(--panel-glow);
            padding: 32px; display: none;
        }
        .tab-section.active { display: block; }
        .tab-section h2 { margin-bottom: 24px; color: var(--text); }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text); }
        input, textarea, select {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--input-bg); font-size: 16px; font-family: 'Inter', sans-serif; color: var(--text);
        }
        input:focus, textarea:focus { outline: none; border-color: var(--green); }
        textarea { min-height: 100px; resize: vertical; }
        .submit-btn {
            width: 100%; padding: 16px 32px; background: var(--green); color: white; border: none;
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation; transition: opacity 0.2s;
        }
        .submit-btn:hover { opacity: 0.85; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress { width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 12px; display: none; }
        .progress-bar { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }
        .status-msg { margin-top: 16px; padding: 12px; border-radius: 8px; display: none; font-weight: 500; }
        .status-msg.success { display: block; background: var(--green-glow); color: var(--green); }
        .status-msg.error { display: block; background: var(--red-glow); color: var(--red); }
        .key-input-row { display: flex; gap: 12px; align-items: flex-start; }
        .key-input-row input { flex: 1; }
        .random-btn {
            padding: 12px 20px; background: var(--green-glow); color: var(--green);
            border: 1px solid var(--green); border-radius: 8px; cursor: pointer; font-weight: 500;
            white-space: nowrap; font-size: 0.95rem; transition: opacity 0.2s;
        }
        .random-btn:hover { opacity: 0.8; }
        .key-display {
            padding: 14px; background: var(--input-bg); border: 1px solid var(--border);
            border-radius: 8px; font-family: monospace; font-size: 1.5rem; letter-spacing: 6px; text-align: center;
        }

        /* My Content styles */
        .content-stats {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px;
        }
        .content-stat {
            background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; text-align: center;
        }
        .content-stat .num { font-size: 2rem; font-weight: 700; color: var(--green); }
        .content-stat .lbl { color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px; }
        .content-subtitle { font-size: 1.1rem; font-weight: 600; color: var(--text); margin: 24px 0 16px; display: flex; align-items: center; gap: 10px; }
        .content-subtitle svg { width: 20px; height: 20px; fill: var(--green); }
        .content-list { display: flex; flex-direction: column; gap: 12px; }
        .content-item {
            display: flex; align-items: center; gap: 16px; padding: 14px; background: var(--input-bg);
            border: 1px solid var(--border); border-radius: 12px; transition: all 0.2s;
        }
        .content-item:hover { border-color: var(--green); }
        .content-item .ci-art {
            width: 56px; height: 56px; border-radius: 10px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
        }
        .content-item .ci-art img { width: 100%; height: 100%; object-fit: cover; }
        .content-item .ci-art svg { width: 24px; height: 24px; fill: var(--text-secondary); opacity: 0.5; }
        .content-item .ci-info { flex: 1; min-width: 0; }
        .content-item .ci-info h4 { color: var(--text); font-size: 0.95rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .content-item .ci-info p { color: var(--text-secondary); font-size: 0.8rem; }
        .content-item .ci-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .ci-btn {
            padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem;
            font-weight: 500; transition: opacity 0.2s;
        }
        .ci-btn:hover { opacity: 0.8; }
        .ci-btn-play { background: var(--green); color: white; }
        .ci-btn-del { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state svg { width: 48px; height: 48px; fill: var(--text-secondary); opacity: 0.3; margin-bottom: 12px; }

        /* Preview player styles */
        .preview-player {
            max-width: 480px; margin: 0 auto; background: var(--surface-solid); border-radius: 24px;
            border: 1px solid var(--panel-border); box-shadow: var(--panel-glow); overflow: hidden;
        }
        .pp-hero {
            position: relative; width: 100%; aspect-ratio: 1; background: linear-gradient(135deg, var(--green-glow), var(--red-glow));
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .pp-hero img { width: 100%; height: 100%; object-fit: cover; }
        .pp-hero svg { width: 80px; height: 80px; fill: var(--text-secondary); opacity: 0.3; }
        .pp-info { padding: 24px; text-align: center; }
        .pp-title { font-size: 1.3rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .pp-artist { font-size: 0.95rem; color: var(--green); font-weight: 500; margin-bottom: 20px; }
        .pp-progress { width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 8px; cursor: pointer; position: relative; }
        .pp-progress-fill { height: 100%; background: var(--green); border-radius: 2px; width: 0%; transition: width 0.1s linear; position: relative; }
        .pp-progress-fill::after {
            content: ''; position: absolute; right: -6px; top: -4px; width: 12px; height: 12px;
            background: var(--green); border-radius: 50%; opacity: 0; transition: opacity 0.2s;
        }
        .pp-progress:hover .pp-progress-fill::after { opacity: 1; }
        .pp-times { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 20px; }
        .pp-controls { display: flex; align-items: center; justify-content: center; gap: 24px; margin-bottom: 20px; }
        .pp-ctrl-btn {
            background: none; border: none; cursor: pointer; padding: 8px; display: flex;
            align-items: center; justify-content: center; transition: transform 0.15s;
        }
        .pp-ctrl-btn:hover { transform: scale(1.1); }
        .pp-ctrl-btn:active { transform: scale(0.95); }
        .pp-ctrl-btn svg { fill: var(--text); }
        .pp-ctrl-btn.pp-play-btn {
            width: 56px; height: 56px; background: var(--green); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .pp-ctrl-btn.pp-play-btn svg { fill: white; width: 24px; height: 24px; }
        .pp-volume { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 16px; }
        .pp-volume svg { width: 18px; height: 18px; fill: var(--text-secondary); }
        .pp-volume-slider {
            -webkit-appearance: none; appearance: none; width: 120px; height: 4px; background: var(--border);
            border-radius: 2px; outline: none;
        }
        .pp-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: var(--green); cursor: pointer;
        }
        .pp-queue { padding: 0 24px 24px; }
        .pp-queue-title { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .pp-track {
            display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px;
            cursor: pointer; transition: background 0.2s;
        }
        .pp-track:hover { background: var(--input-bg); }
        .pp-track.active { background: var(--green-glow); }
        .pp-track-num { width: 24px; text-align: center; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        .pp-track-art {
            width: 40px; height: 40px; border-radius: 8px; background: var(--green-glow);
            display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;
        }
        .pp-track-art img { width: 100%; height: 100%; object-fit: cover; }
        .pp-track-art svg { width: 18px; height: 18px; fill: var(--text-secondary); opacity: 0.5; }
        .pp-track-info { flex: 1; min-width: 0; }
        .pp-track-info h4 { font-size: 0.9rem; color: var(--text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pp-track-info p { font-size: 0.75rem; color: var(--text-secondary); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface-solid);
            border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 48px;
            padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 1000;
        }
        .bottom-nav a {
            display: flex; flex-direction: column; align-items: center; text-decoration: none;
            color: var(--text-secondary); font-size: 0.7rem; font-weight: 500; padding: 4px 16px;
            -webkit-tap-highlight-color: transparent; gap: 4px; transition: color 0.2s;
        }
        .bottom-nav a.active { color: var(--green); }
        .bottom-nav a:hover { color: var(--green); }
        .bottom-nav a svg { width: 22px; height: 22px; fill: currentColor; }
        @media (max-width: 768px) {
            body { padding: 12px; padding-bottom: 100px; }
            .header { flex-direction: column; gap: 16px; text-align: center; padding: 16px; }
            .logo { margin-left: 0; } .header nav { display: none; }
            .tabs { gap: 6px; }
            .tab { flex: 1; min-width: calc(50% - 6px); padding: 10px 12px; font-size: 0.85rem; text-align: center; }
            .tab-section { padding: 24px 20px; }
            .content-stats { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .content-item { gap: 12px; padding: 12px; }
            .content-item .ci-art { width: 48px; height: 48px; }
            .ci-btn { padding: 6px 10px; font-size: 0.75rem; }
            .preview-player { border-radius: 20px; }
        }
        @media (max-width: 480px) {
            .header { border-radius: 16px; } .logo { font-size: 1.2rem; }
            .tab { min-width: calc(50% - 6px); padding: 8px 10px; font-size: 0.8rem; }
            .tab-section { padding: 20px 16px; border-radius: 16px; }
            .key-input-row { flex-direction: column; }
            .random-btn { width: 100%; text-align: center; }
            .content-stats { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
            .content-stat { padding: 12px 8px; }
            .content-stat .num { font-size: 1.5rem; }
            .content-item .ci-actions { flex-direction: column; gap: 4px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo shimmer-text">Creator Dashboard</div>
        <nav><a href="player.html">Music</a><a href="videos.html">Videos</a><a href="welcome.html">Logout</a></nav>
    </div>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('myContent', this)">My Content</button>
            <button class="tab" onclick="showTab('music', this)">Upload Music</button>
            <button class="tab" onclick="showTab('video', this)">Upload Video</button>
            <button class="tab" onclick="showTab('profile', this)">Profile</button>
            <button class="tab" onclick="showTab('preview', this)">Preview</button>
        </div>

        <!-- MY CONTENT TAB -->
        <div class="tab-section active" id="myContentSection">
            <h2>My Content</h2>
            <div class="content-stats">
                <div class="content-stat"><div class="num" id="myTrackCount">0</div><div class="lbl">Tracks</div></div>
                <div class="content-stat"><div class="num" id="myVideoCount">0</div><div class="lbl">Videos</div></div>
                <div class="content-stat"><div class="num" id="mySubscribers">0</div><div class="lbl">Subscribers</div></div>
            </div>
            <div class="content-subtitle">
                <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                Tracks
            </div>
            <div class="content-list" id="myTracksList"></div>
            <div class="content-subtitle" style="margin-top:32px;">
                <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                Videos
            </div>
            <div class="content-list" id="myVideosList"></div>
        </div>

        <!-- UPLOAD MUSIC TAB -->
        <div class="tab-section" id="musicSection">
            <h2>Upload New Track</h2>
            <form id="musicForm">
                <div class="form-group"><label>Track Title *</label><input type="text" name="title" required></div>
                <div class="form-group"><label>Artist Name *</label><input type="text" name="artist" required></div>
                <div class="form-group"><label>Audio File *</label><input type="file" accept="audio/*" name="audio" required></div>
                <div class="form-group"><label>Artwork (optional)</label><input type="file" accept="image/*" name="artwork"></div>
                <div class="form-group"><label>Description (optional)</label><textarea name="description" placeholder="A short description of this track"></textarea></div>
                <div class="form-group"><label>Backstory (optional)</label><textarea name="backstory" placeholder="The story behind the song..."></textarea></div>
                <div class="form-group"><label>Lyrics (optional)</label><textarea name="lyrics"></textarea></div>
                <div class="form-group"><label>Producer (optional)</label><input type="text" name="credits_producer" placeholder="e.g. John Smith"></div>
                <div class="form-group"><label>Writer (optional)</label><input type="text" name="credits_writer" placeholder="e.g. Jane Doe"></div>
                <div class="form-group"><label>Engineer (optional)</label><input type="text" name="credits_engineer" placeholder="e.g. Bob Johnson"></div>
                <div class="form-group"><label>Mixed By (optional)</label><input type="text" name="credits_mixer" placeholder="e.g. Sarah Williams"></div>
                <div class="form-group"><label>Mastered By (optional)</label><input type="text" name="credits_master" placeholder="e.g. Mike Brown"></div>
                <button type="submit" class="submit-btn" id="musicSubmitBtn">Upload Track</button>
                <div class="progress" id="musicProgress"><div class="progress-bar" id="musicBar"></div></div>
                <div class="status-msg" id="musicStatus"></div>
            </form>
        </div>

        <!-- UPLOAD VIDEO TAB -->
        <div class="tab-section" id="videoSection">
            <h2>Upload New Video</h2>
            <form id="videoForm">
                <div class="form-group"><label>Video Title *</label><input type="text" name="title" required></div>
                <div class="form-group"><label>Video File *</label><input type="file" accept="video/*" name="video" required></div>
                <div class="form-group"><label>Thumbnail (optional)</label><input type="file" accept="image/*" name="thumbnail"></div>
                <div class="form-group"><label>Description (optional)</label><textarea name="description"></textarea></div>
                <button type="submit" class="submit-btn" id="videoSubmitBtn">Upload Video</button>
                <div class="progress" id="videoProgress"><div class="progress-bar" id="videoBar"></div></div>
                <div class="status-msg" id="videoStatus"></div>
            </form>
        </div>

        <!-- PROFILE TAB -->
        <div class="tab-section" id="profileSection">
            <h2>Your Public Profile</h2>
            <p style="color:var(--text-secondary); margin-bottom:20px;">Customize how listeners see you on the platform.</p>
            <form id="profileForm">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:8px;">
                        <div id="profilePhotoPreview" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--green-glow),var(--red-glow));display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:2rem;font-weight:700;color:var(--green);flex-shrink:0;"></div>
                        <input type="file" accept="image/*" id="profilePhotoInput" style="flex:1;">
                    </div>
                </div>
                <div class="form-group"><label>Artist Name</label><input type="text" id="profileArtistName" placeholder="Your stage name"></div>
                <div class="form-group"><label>Bio</label><textarea id="profileBio" placeholder="Tell listeners about yourself..." rows="4"></textarea></div>
                <div class="form-group">
                    <label>Creator Title / Tagline <span style="font-size:0.8rem;color:var(--text-secondary);">(shown on home page when featured)</span></label>
                    <input type="text" id="profileCreatorTitle" placeholder="e.g. R&B Soul Artist, Lo-Fi Producer" minlength="10" maxlength="50">
                    <div style="text-align:right;font-size:0.75rem;color:var(--text-secondary);margin-top:4px;"><span id="titleCharCount">0</span>/50</div>
                </div>
                <button type="submit" class="submit-btn">Save Profile</button>
                <div class="status-msg" id="profileMessage"></div>
            </form>
        </div>

        <!-- PREVIEW AS LISTENER TAB -->
        <div class="tab-section" id="previewSection">
            <h2>Preview as Listener</h2>
            <p style="color:var(--text-secondary); margin-bottom:24px;">This is how listeners see your music when they enter your key.</p>
            <div class="preview-player" id="previewPlayer">
                <div class="pp-hero" id="ppHero">
                    <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="pp-info">
                    <div class="pp-title" id="ppTitle">No tracks yet</div>
                    <div class="pp-artist" id="ppArtist">Upload some music to preview</div>
                    <div class="pp-progress" id="ppProgressBar">
                        <div class="pp-progress-fill" id="ppProgressFill"></div>
                    </div>
                    <div class="pp-times">
                        <span id="ppCurrentTime">0:00</span>
                        <span id="ppDuration">0:00</span>
                    </div>
                    <div class="pp-controls">
                        <button class="pp-ctrl-btn" onclick="ppShuffle()" title="Shuffle">
                            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                        </button>
                        <button class="pp-ctrl-btn" onclick="ppPrev()" title="Previous">
                            <svg width="24" height="24" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                        </button>
                        <button class="pp-ctrl-btn pp-play-btn" onclick="ppTogglePlay()" id="ppPlayBtn" title="Play">
                            <svg viewBox="0 0 24 24" id="ppPlayIcon"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="pp-ctrl-btn" onclick="ppNext()" title="Next">
                            <svg width="24" height="24" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                        </button>
                        <button class="pp-ctrl-btn" onclick="ppRepeat()" title="Repeat">
                            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                        </button>
                    </div>
                    <div class="pp-volume">
                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                        <input type="range" class="pp-volume-slider" min="0" max="100" value="80" oninput="ppSetVolume(this.value)">
                    </div>
                </div>
                <div class="pp-queue" id="ppQueue">
                    <div class="pp-queue-title">Queue</div>
                    <div id="ppQueueList"></div>
                </div>
            </div>
            <audio id="ppAudio"></audio>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="welcome.html"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</a>
        <a href="master-admin.html"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>Admin</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        var API = window.location.origin;
        // Auth token helper — checks both localStorage and sessionStorage
        function getAuthToken() {
            return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }
        var authToken = getAuthToken();
        var creatorProfile = null;
        var myTracks = [];
        var myVideos = [];

        // Preview player state
        var ppTracks = [];
        var ppCurrentIndex = 0;
        var ppIsPlaying = false;
        var ppShuffleOn = false;
        var ppRepeatOn = false;
        var ppAudio = document.getElementById('ppAudio');

        function showTab(tab, btn) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-section').forEach(function(s) { s.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
            if (tab === 'myContent') loadMyContent();
            if (tab === 'profile') loadProfileTab();
            if (tab === 'preview') loadPreview();
        }

        // Load creator profile
        async function loadCreatorProfile() {
            try {
                var response = await fetch(API + '/api/creators/me', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (response.ok) {
                    var data = await response.json();
                    creatorProfile = data.creator;
                    document.querySelector('.logo').textContent = (creatorProfile.artist_name || creatorProfile.first_name) + "'s Dashboard";
                }
            } catch (err) { console.error('Profile load error:', err); }
        }

        // Load My Content
        async function loadMyContent() {
            try {
                var tracksRes = await fetch(API + '/api/creators/my-tracks', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var tracksData = await tracksRes.json();
                myTracks = tracksData.tracks || [];

                var videosRes = await fetch(API + '/api/creators/my-videos', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var videosData = await videosRes.json();
                myVideos = videosData.videos || [];

                document.getElementById('myTrackCount').textContent = myTracks.length;
                document.getElementById('myVideoCount').textContent = myVideos.length;
                // Subscriber count will be loaded separately
                loadSubscriberCount();

                renderMyTracks();
                renderMyVideos();
            } catch (err) { console.error('Content load error:', err); }
        }

        function renderMyTracks() {
            var list = document.getElementById('myTracksList');
            if (myTracks.length === 0) {
                list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><p>No tracks uploaded yet</p></div>';
                return;
            }
            list.innerHTML = '';
            myTracks.forEach(function(track, idx) {
                var item = document.createElement('div');
                item.className = 'content-item';
                item.setAttribute('data-id', track.id);
                var artHtml = track.artwork_url
                    ? '<img src="' + track.artwork_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                var date = new Date(track.uploaded_at).toLocaleDateString();
                var size = track.file_size ? (track.file_size / (1024 * 1024)).toFixed(1) + ' MB' : '';
                var descLine = track.description ? '<br><span style="color:var(--text-secondary);font-size:0.8rem;">' + track.description + '</span>' : '';
                item.innerHTML =
                    '<span class="drag-handle" style="cursor:grab;padding:0 8px;font-size:1.2rem;color:var(--text-secondary);">&#9776;</span>' +
                    '<div class="ci-art">' + artHtml + '</div>' +
                    '<div class="ci-info"><h4>' + track.title + '</h4><p>' + track.artist + ' &middot; ' + date + (size ? ' &middot; ' + size : '') + '</p>' + descLine + '</div>' +
                    '<div class="ci-actions"><button class="ci-btn ci-btn-play" onclick="previewTrack(\'' + track.audio_url + '\')">Play</button>' +
                    '<button class="ci-btn ci-btn-del" onclick="deleteTrack(\'' + track.id + '\')">Delete</button></div>';
                list.appendChild(item);
            });

            // Initialize SortableJS for drag-and-drop reordering
            if (typeof Sortable !== 'undefined') {
                new Sortable(list, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async function() {
                        var items = list.querySelectorAll('.content-item[data-id]');
                        var songs = [];
                        items.forEach(function(item, i) {
                            songs.push({ id: item.getAttribute('data-id'), display_order: i });
                        });
                        try {
                            await fetch(API + '/api/songs/reorder', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                                body: JSON.stringify({ songs: songs })
                            });
                        } catch (err) { console.error('Reorder error:', err); }
                    }
                });
            }
        }

        function renderMyVideos() {
            var list = document.getElementById('myVideosList');
            if (myVideos.length === 0) {
                list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg><p>No videos uploaded yet</p></div>';
                return;
            }
            list.innerHTML = '';
            myVideos.forEach(function(video) {
                var item = document.createElement('div');
                item.className = 'content-item';
                var artHtml = video.thumbnail_url
                    ? '<img src="' + video.thumbnail_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>';
                var date = new Date(video.uploaded_at).toLocaleDateString();
                item.innerHTML = '<div class="ci-art">' + artHtml + '</div>' +
                    '<div class="ci-info"><h4>' + video.title + '</h4><p>' + (video.category || 'Video') + ' &middot; ' + date + '</p></div>' +
                    '<div class="ci-actions"><button class="ci-btn ci-btn-play" onclick="window.open(\'' + video.video_url + '\', \'_blank\')">Watch</button>' +
                    '<button class="ci-btn ci-btn-del" onclick="deleteVideo(\'' + video.id + '\')">Delete</button></div>';
                list.appendChild(item);
            });
        }

        function previewTrack(url) {
            ppAudio.src = url;
            ppAudio.play();
        }

        async function deleteTrack(trackId) {
            if (!confirm('Delete this track? This cannot be undone.')) return;
            try {
                var response = await fetch(API + '/api/creators/tracks/' + trackId, {
                    method: 'DELETE', headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (response.ok) loadMyContent();
                else alert('Failed to delete track');
            } catch (err) { alert('Error deleting track'); }
        }

        async function deleteVideo(videoId) {
            if (!confirm('Delete this video? This cannot be undone.')) return;
            try {
                var response = await fetch(API + '/api/creators/videos/' + videoId, {
                    method: 'DELETE', headers: { 'Authorization': 'Bearer ' + authToken }
                });
                if (response.ok) loadMyContent();
                else alert('Failed to delete video');
            } catch (err) { alert('Error deleting video'); }
        }

        // Get Cloudinary upload signature from server
        async function getUploadSignature(folder) {
            var response = await fetch(API + '/api/upload/sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({ folder: folder })
            });
            if (!response.ok) {
                var errData = {};
                try { errData = await response.json(); } catch(e) {}
                if (response.status === 401) {
                    throw new Error('Not authenticated. Please log in again.');
                }
                throw new Error(errData.error || 'Failed to get upload signature (status ' + response.status + ')');
            }
            return response.json();
        }

        // Upload file directly to Cloudinary from the browser
        function uploadToCloudinary(file, folder, resourceType, progressFill, btn) {
            return new Promise(async function(resolve, reject) {
                var settled = false;
                function safeResolve(val) { if (!settled) { settled = true; resolve(val); } }
                function safeReject(err) { if (!settled) { settled = true; reject(err); } }

                try {
                    var fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    console.log('[Upload] File details — name:', file.name, 'size:', fileSizeMB + 'MB', 'type:', file.type, 'resourceType:', resourceType);
                    console.log('[Upload] Getting signature for folder:', folder);
                    var sig = await getUploadSignature(folder);
                    console.log('[Upload] Signature received, cloud:', sig.cloud_name);

                    var uploadUrl = 'https://api.cloudinary.com/v1_1/' + sig.cloud_name + '/' + resourceType + '/upload';
                    console.log('[Upload] Upload URL:', uploadUrl);

                    var formData = new FormData();
                    formData.append('file', file);
                    formData.append('api_key', sig.api_key);
                    formData.append('timestamp', sig.timestamp);
                    formData.append('signature', sig.signature);
                    formData.append('folder', sig.folder);

                    var xhr = new XMLHttpRequest();
                    var uploadFinished = false;
                    var processingTimer = null;

                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            var pct = Math.round((e.loaded / e.total) * 90);
                            progressFill.style.width = pct + '%';
                            btn.textContent = 'Uploading... ' + pct + '%';
                        }
                    });
                    // When all bytes are sent, start a 5-minute processing timeout
                    xhr.upload.addEventListener('load', function() {
                        uploadFinished = true;
                        btn.textContent = 'Processing on server...';
                        console.log('[Upload] All bytes sent to Cloudinary, waiting for processing response...');
                        processingTimer = setTimeout(function() {
                            console.error('[Upload] Cloudinary processing timed out after 5 minutes');
                            xhr.abort();
                            safeReject(new Error('Cloudinary took too long to process the file (5 min). Try a smaller file.'));
                        }, 300000);
                    });
                    xhr.addEventListener('load', function() {
                        if (processingTimer) clearTimeout(processingTimer);
                        console.log('[Upload] Cloudinary responded — status:', xhr.status, 'body preview:', xhr.responseText.substring(0, 300));
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                var result = JSON.parse(xhr.responseText);
                                if (!result.secure_url) {
                                    console.error('[Upload] Cloudinary response missing secure_url:', xhr.responseText.substring(0, 500));
                                    safeReject(new Error('Cloudinary did not return a file URL. Response: ' + xhr.responseText.substring(0, 200)));
                                    return;
                                }
                                console.log('[Upload] Success! URL:', result.secure_url);
                                safeResolve(result.secure_url);
                            } catch(e) {
                                console.error('[Upload] Failed to parse Cloudinary success response:', e.message);
                                safeReject(new Error('Failed to parse Cloudinary response: ' + e.message + '. Raw: ' + xhr.responseText.substring(0, 200)));
                            }
                        } else {
                            try {
                                var err = JSON.parse(xhr.responseText);
                                var msg = err.error && err.error.message ? err.error.message : 'Upload failed (status ' + xhr.status + ')';
                                console.error('[Upload] Cloudinary error (status ' + xhr.status + '):', msg);
                                console.error('[Upload] Full error response:', xhr.responseText.substring(0, 500));
                                console.error('[Upload] File was:', file.name, fileSizeMB + 'MB', 'type:', file.type, 'resource_type:', resourceType);
                                // Show Cloudinary's exact error with helpful context
                                msg = 'Cloudinary error: ' + msg + ' (file: ' + fileSizeMB + 'MB ' + (file.type || 'unknown type') + ', uploaded as ' + resourceType + ')';
                                safeReject(new Error(msg));
                            } catch(e) {
                                console.error('[Upload] Unparseable error response:', xhr.responseText.substring(0, 300));
                                safeReject(new Error('Upload failed with status ' + xhr.status + '. Response: ' + xhr.responseText.substring(0, 200)));
                            }
                        }
                    });
                    xhr.addEventListener('error', function() {
                        if (processingTimer) clearTimeout(processingTimer);
                        console.error('[Upload] XHR network error');
                        safeReject(new Error('Network error during upload. Check your internet connection and try again.'));
                    });
                    xhr.addEventListener('abort', function() {
                        if (processingTimer) clearTimeout(processingTimer);
                        console.warn('[Upload] XHR aborted');
                        safeReject(new Error('Upload was cancelled.'));
                    });
                    xhr.addEventListener('timeout', function() {
                        if (processingTimer) clearTimeout(processingTimer);
                        console.error('[Upload] XHR timed out');
                        safeReject(new Error('Upload timed out after 10 minutes. Try a smaller file or check your connection.'));
                    });
                    xhr.open('POST', uploadUrl);
                    xhr.timeout = 600000;
                    xhr.send(formData);
                } catch (err) {
                    console.error('[Upload] Setup error:', err);
                    safeReject(err);
                }
            });
        }

        // Compress audio to MP3 in the browser using Web Audio API + lamejs
        // Falls back to uploading original file if compression fails or times out
        function compressToMp3(file, btn, bar) {
            var ext = file.name.split('.').pop().toLowerCase();
            var sizeMB = (file.size / (1024 * 1024)).toFixed(1);

            // Skip compression for MP3 files or small files (<10MB)
            if (ext === 'mp3' || file.size < 10 * 1024 * 1024) {
                console.log('[Compress] Skipping — ' + ext.toUpperCase() + ' ' + sizeMB + 'MB (no compression needed)');
                return Promise.resolve(file);
            }

            console.log('[Compress] Starting — ' + ext.toUpperCase() + ' ' + sizeMB + 'MB');

            // Compression promise
            var compressionPromise = new Promise(function(resolve, reject) {
                btn.textContent = 'Reading audio file...';
                bar.style.width = '2%';

                var reader = new FileReader();
                reader.onload = function(e) {
                    console.log('[Compress] File read into memory (' + sizeMB + 'MB), decoding audio...');
                    btn.textContent = 'Decoding audio...';
                    bar.style.width = '5%';

                    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    audioCtx.decodeAudioData(e.target.result, function(buffer) {
                        var duration = buffer.duration;
                        console.log('[Compress] Decoded — ' + duration.toFixed(1) + 's, ' + buffer.numberOfChannels + 'ch, ' + buffer.sampleRate + 'Hz');
                        btn.textContent = 'Loading MP3 encoder...';
                        bar.style.width = '10%';

                        // Import lamejs dynamically (check if already loaded)
                        if (typeof lamejs !== 'undefined') {
                            doEncode(buffer, audioCtx, resolve, reject);
                        } else {
                            var script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js';
                            script.onload = function() {
                                console.log('[Compress] lamejs loaded');
                                doEncode(buffer, audioCtx, resolve, reject);
                            };
                            script.onerror = function() {
                                audioCtx.close();
                                console.warn('[Compress] Failed to load lamejs — uploading original file');
                                resolve(file);
                            };
                            document.head.appendChild(script);
                        }
                    }, function(err) {
                        console.warn('[Compress] decodeAudioData failed — uploading original file. Error:', err);
                        resolve(file); // fallback: upload original
                    });
                };
                reader.onerror = function() {
                    console.warn('[Compress] FileReader failed — uploading original file');
                    resolve(file); // fallback: upload original
                };
                reader.readAsArrayBuffer(file);

                function doEncode(buffer, audioCtx, resolve, reject) {
                    try {
                        var channels = buffer.numberOfChannels;
                        var sampleRate = buffer.sampleRate;
                        var mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 192); // 192kbps high quality
                        var mp3Data = [];

                        var left = buffer.getChannelData(0);
                        var right = channels > 1 ? buffer.getChannelData(1) : left;

                        var sampleBlockSize = 1152;
                        var totalSamples = left.length;
                        var processedSamples = 0;
                        var lastLogPct = 0;

                        function floatTo16Bit(arr) {
                            var buf = new Int16Array(arr.length);
                            for (var i = 0; i < arr.length; i++) {
                                var s = Math.max(-1, Math.min(1, arr[i]));
                                buf[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            }
                            return buf;
                        }

                        // Process in larger chunks for speed (200 blocks per iteration instead of 50)
                        function processChunk() {
                            try {
                                var end = Math.min(processedSamples + sampleBlockSize * 200, totalSamples);
                                while (processedSamples < end) {
                                    var sliceEnd = Math.min(processedSamples + sampleBlockSize, totalSamples);
                                    var leftChunk = floatTo16Bit(left.slice(processedSamples, sliceEnd));
                                    var rightChunk = channels > 1 ? floatTo16Bit(right.slice(processedSamples, sliceEnd)) : leftChunk;
                                    var mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
                                    if (mp3buf.length > 0) mp3Data.push(mp3buf);
                                    processedSamples = sliceEnd;
                                }

                                var pctDone = Math.round((processedSamples / totalSamples) * 100);
                                var barPct = Math.round((processedSamples / totalSamples) * 30) + 10;
                                bar.style.width = barPct + '%';
                                btn.textContent = 'Encoding MP3... ' + pctDone + '%';

                                // Log every 25%
                                if (pctDone >= lastLogPct + 25) {
                                    lastLogPct = Math.floor(pctDone / 25) * 25;
                                    console.log('[Compress] Encoding ' + pctDone + '% complete');
                                }

                                if (processedSamples < totalSamples) {
                                    setTimeout(processChunk, 0);
                                } else {
                                    var flush = mp3encoder.flush();
                                    if (flush.length > 0) mp3Data.push(flush);

                                    var blob = new Blob(mp3Data, { type: 'audio/mpeg' });
                                    var mp3File = new File([blob], file.name.replace(/\.[^.]+$/, '.mp3'), { type: 'audio/mpeg' });

                                    var origMB = (file.size / (1024 * 1024)).toFixed(1);
                                    var newMB = (mp3File.size / (1024 * 1024)).toFixed(1);
                                    console.log('[Compress] Done! ' + origMB + 'MB ' + ext.toUpperCase() + ' → ' + newMB + 'MB MP3 (192kbps)');

                                    audioCtx.close();
                                    resolve(mp3File);
                                }
                            } catch (err) {
                                audioCtx.close();
                                console.warn('[Compress] Encoding error — uploading original file. Error:', err.message);
                                resolve(file); // fallback: upload original
                            }
                        }
                        processChunk();
                    } catch (err) {
                        audioCtx.close();
                        console.warn('[Compress] Encoder init failed — uploading original file. Error:', err.message);
                        resolve(file); // fallback: upload original
                    }
                }
            });

            // 3-minute timeout — if compression is too slow, upload the original file
            var timeoutPromise = new Promise(function(resolve) {
                setTimeout(function() {
                    console.warn('[Compress] Timed out after 3 minutes — uploading original file (' + sizeMB + 'MB)');
                    btn.textContent = 'Compression slow, uploading original...';
                    resolve(file);
                }, 180000);
            });

            return Promise.race([compressionPromise, timeoutPromise]);
        }

        // Upload music: compress → Cloudinary directly → save URL to server
        document.getElementById('musicForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var form = e.target;
            var btn = document.getElementById('musicSubmitBtn');
            var progress = document.getElementById('musicProgress');
            var bar = document.getElementById('musicBar');
            var status = document.getElementById('musicStatus');

            var audioInput = form.querySelector('input[name="audio"]');
            var artworkInput = form.querySelector('input[name="artwork"]');
            if (!audioInput.files[0]) { alert('Please select an audio file'); return; }

            // Check auth token before starting
            if (!getAuthToken()) {
                alert('You are not logged in. Please log in again.');
                window.location.href = 'login.html';
                return;
            }
            authToken = getAuthToken();

            btn.disabled = true; btn.textContent = 'Preparing...';
            progress.style.display = 'block'; bar.style.width = '0%';
            status.style.display = 'none'; status.className = 'status-msg';

            try {
                var origFile = audioInput.files[0];
                console.log('[MusicUpload] Starting — file:', origFile.name, 'size:', (origFile.size / 1024 / 1024).toFixed(2) + 'MB', 'type:', origFile.type);

                // Step 1: Compress large audio files to MP3 in the browser
                console.log('[MusicUpload] Step 1: Compressing...');
                var audioFile = await compressToMp3(audioInput.files[0], btn, bar);
                console.log('[MusicUpload] Step 1 done — file:', audioFile.name, 'size:', (audioFile.size / 1024 / 1024).toFixed(2) + 'MB', 'type:', audioFile.type, 'same as original?', audioFile === origFile);

                // Validate file size for Cloudinary (100MB limit for audio/video on free tier)
                if (audioFile.size > 100 * 1024 * 1024) {
                    throw new Error('File is too large (' + (audioFile.size / 1024 / 1024).toFixed(1) + 'MB). Maximum upload size is 100MB.');
                }

                // Step 2: Upload compressed audio directly to Cloudinary
                console.log('[MusicUpload] Step 2: Uploading to Cloudinary...');
                btn.textContent = 'Uploading...';
                bar.style.width = '40%';
                var audioUrl = await uploadToCloudinary(audioFile, 'alpha-channel/audio', 'video', bar, btn);
                console.log('[MusicUpload] Step 2 done — audioUrl:', audioUrl);

                // Step 3: Upload artwork if provided
                var artworkUrl = null;
                if (artworkInput.files[0]) {
                    console.log('[MusicUpload] Step 3: Uploading artwork...');
                    btn.textContent = 'Uploading artwork...';
                    artworkUrl = await uploadToCloudinary(artworkInput.files[0], 'alpha-channel/artwork', 'image', bar, btn);
                    console.log('[MusicUpload] Step 3 done — artworkUrl:', artworkUrl);
                } else {
                    console.log('[MusicUpload] Step 3: No artwork, skipping');
                }

                // Step 4: Save to database via server
                console.log('[MusicUpload] Step 4: Saving to database...');
                btn.textContent = 'Saving...'; bar.style.width = '95%';
                var finalExt = audioFile.name.split('.').pop().toLowerCase();
                var response = await fetch(API + '/api/upload/music', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({
                        title: form.querySelector('input[name="title"]').value,
                        artist: form.querySelector('input[name="artist"]').value,
                        lyrics: form.querySelector('textarea[name="lyrics"]').value || null,
                        audio_url: audioUrl,
                        artwork_url: artworkUrl,
                        file_size: audioFile.size,
                        format: finalExt,
                        credits_producer: form.querySelector('input[name="credits_producer"]').value || null,
                        credits_writer: form.querySelector('input[name="credits_writer"]').value || null,
                        credits_engineer: form.querySelector('input[name="credits_engineer"]').value || null,
                        credits_mixer: form.querySelector('input[name="credits_mixer"]').value || null,
                        credits_master: form.querySelector('input[name="credits_master"]').value || null,
                        description: form.querySelector('textarea[name="description"]').value || null,
                        backstory: form.querySelector('textarea[name="backstory"]').value || null
                    })
                });
                console.log('[MusicUpload] Step 4 fetch done — status:', response.status);
                var result = await response.json();
                console.log('[MusicUpload] Step 4 result:', JSON.stringify(result));
                if (response.ok && result.success) {
                    bar.style.width = '100%'; status.className = 'status-msg success';
                    status.textContent = 'Track uploaded successfully!'; status.style.display = 'block'; form.reset();
                    console.log('[MusicUpload] SUCCESS!');
                } else {
                    status.className = 'status-msg error';
                    status.textContent = result.error || 'Failed to save track.'; status.style.display = 'block';
                    console.error('[MusicUpload] Server error:', result.error);
                }
            } catch (err) {
                console.error('[MusicUpload] CAUGHT ERROR:', err.message, err.stack);
                status.className = 'status-msg error';
                status.textContent = 'Upload error: ' + err.message; status.style.display = 'block';
            }
            btn.disabled = false; btn.textContent = 'Upload Track';
            setTimeout(function() { progress.style.display = 'none'; bar.style.width = '0%'; }, 4000);
        });

        // Upload video: browser → Cloudinary directly, then save URL to server
        document.getElementById('videoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var form = e.target;
            var btn = document.getElementById('videoSubmitBtn');
            var progress = document.getElementById('videoProgress');
            var bar = document.getElementById('videoBar');
            var status = document.getElementById('videoStatus');

            var videoInput = form.querySelector('input[name="video"]');
            var thumbInput = form.querySelector('input[name="thumbnail"]');
            if (!videoInput.files[0]) { alert('Please select a video file'); return; }

            // Check auth token before starting
            if (!getAuthToken()) {
                alert('You are not logged in. Please log in again.');
                window.location.href = 'login.html';
                return;
            }
            authToken = getAuthToken();

            btn.disabled = true; btn.textContent = 'Uploading...';
            progress.style.display = 'block'; bar.style.width = '0%';
            status.style.display = 'none'; status.className = 'status-msg';

            try {
                // Validate file size for Cloudinary (100MB limit for video on free tier)
                if (videoInput.files[0].size > 100 * 1024 * 1024) {
                    throw new Error('Video is too large (' + (videoInput.files[0].size / 1024 / 1024).toFixed(1) + 'MB). Maximum upload size is 100MB.');
                }

                var videoUrl = await uploadToCloudinary(videoInput.files[0], 'alpha-channel/videos', 'video', bar, btn);

                var thumbnailUrl = null;
                if (thumbInput.files[0]) {
                    btn.textContent = 'Uploading thumbnail...';
                    thumbnailUrl = await uploadToCloudinary(thumbInput.files[0], 'alpha-channel/thumbnails', 'image', bar, btn);
                }

                btn.textContent = 'Saving...'; bar.style.width = '95%';
                var ext = videoInput.files[0].name.split('.').pop().toLowerCase();
                var response = await fetch(API + '/api/upload/video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({
                        title: form.querySelector('input[name="title"]').value,
                        description: form.querySelector('textarea[name="description"]').value || null,
                        video_url: videoUrl,
                        thumbnail_url: thumbnailUrl,
                        file_size: videoInput.files[0].size,
                        format: ext
                    })
                });
                var result = await response.json();
                if (response.ok && result.success) {
                    bar.style.width = '100%'; status.className = 'status-msg success';
                    status.textContent = 'Video uploaded successfully!'; status.style.display = 'block'; form.reset();
                } else {
                    status.className = 'status-msg error';
                    status.textContent = result.error || 'Failed to save video.'; status.style.display = 'block';
                }
            } catch (err) {
                status.className = 'status-msg error';
                status.textContent = 'Upload error: ' + err.message; status.style.display = 'block';
            }
            btn.disabled = false; btn.textContent = 'Upload Video';
            setTimeout(function() { progress.style.display = 'none'; bar.style.width = '0%'; }, 4000);
        });

        // Profile management
        async function loadSubscriberCount() {
            try {
                var resp = await fetch(API + '/api/creators-public/' + creatorProfile.id + '/profile');
                var data = await resp.json();
                document.getElementById('mySubscribers').textContent = parseInt(data.creator.subscriber_count) || 0;
            } catch (e) { document.getElementById('mySubscribers').textContent = '0'; }
        }

        async function loadProfileTab() {
            if (!creatorProfile) return;
            document.getElementById('profileArtistName').value = creatorProfile.artist_name || '';
            document.getElementById('profileBio').value = creatorProfile.bio || '';
            document.getElementById('profileCreatorTitle').value = creatorProfile.creator_title || '';
            document.getElementById('titleCharCount').textContent = (creatorProfile.creator_title || '').length;
            var photoPreview = document.getElementById('profilePhotoPreview');
            if (creatorProfile.profile_photo) {
                photoPreview.innerHTML = '<img src="' + creatorProfile.profile_photo + '" style="width:100%;height:100%;object-fit:cover;">';
            } else {
                photoPreview.textContent = (creatorProfile.artist_name || creatorProfile.username || '?').charAt(0).toUpperCase();
            }
        }

        document.getElementById('profileCreatorTitle').addEventListener('input', function() {
            document.getElementById('titleCharCount').textContent = this.value.length;
        });

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var msg = document.getElementById('profileMessage');
            msg.style.display = 'none';

            var photoFile = document.getElementById('profilePhotoInput').files[0];
            var photoUrl = creatorProfile.profile_photo || null;

            try {
                // Upload photo if selected
                if (photoFile) {
                    msg.className = 'status-msg'; msg.textContent = 'Uploading photo...'; msg.style.display = 'block';
                    photoUrl = await uploadToCloudinary(photoFile, 'alpha-channel/profiles', 'image', null, null);
                }

                var response = await fetch(API + '/api/auth/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({
                        artist_name: document.getElementById('profileArtistName').value,
                        bio: document.getElementById('profileBio').value,
                        profile_photo: photoUrl,
                        creator_title: document.getElementById('profileCreatorTitle').value
                    })
                });

                if (response.ok) {
                    creatorProfile.artist_name = document.getElementById('profileArtistName').value;
                    creatorProfile.bio = document.getElementById('profileBio').value;
                    creatorProfile.profile_photo = photoUrl;
                    creatorProfile.creator_title = document.getElementById('profileCreatorTitle').value;
                    document.querySelector('.logo').textContent = (creatorProfile.artist_name || creatorProfile.first_name) + "'s Dashboard";
                    loadProfileTab();
                    msg.className = 'status-msg success'; msg.textContent = 'Profile saved!'; msg.style.display = 'block';
                } else {
                    var err = await response.json();
                    msg.className = 'status-msg error'; msg.textContent = err.error || 'Failed to save'; msg.style.display = 'block';
                }
            } catch (err) {
                msg.className = 'status-msg error'; msg.textContent = 'Error saving profile: ' + err.message; msg.style.display = 'block';
            }
        });

        // ===== PREVIEW PLAYER =====
        async function loadPreview() {
            try {
                var res = await fetch(API + '/api/creators/my-tracks', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                var data = await res.json();
                ppTracks = data.tracks || [];
                ppCurrentIndex = 0;
                renderQueue();
                if (ppTracks.length > 0) {
                    loadPPTrack(0);
                } else {
                    document.getElementById('ppTitle').textContent = 'No tracks yet';
                    document.getElementById('ppArtist').textContent = 'Upload music to see the listener preview';
                    document.getElementById('ppHero').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                }
            } catch (err) { console.error('Preview load error:', err); }
        }

        function loadPPTrack(index) {
            if (index < 0 || index >= ppTracks.length) return;
            ppCurrentIndex = index;
            var track = ppTracks[index];
            document.getElementById('ppTitle').textContent = track.title;
            document.getElementById('ppArtist').textContent = track.artist;
            if (track.artwork_url) {
                document.getElementById('ppHero').innerHTML = '<img src="' + track.artwork_url + '">';
            } else {
                document.getElementById('ppHero').innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
            }
            ppAudio.src = track.audio_url;
            document.getElementById('ppProgressFill').style.width = '0%';
            document.getElementById('ppCurrentTime').textContent = '0:00';
            document.getElementById('ppDuration').textContent = '0:00';
            highlightQueueTrack(index);
        }

        function ppTogglePlay() {
            if (ppTracks.length === 0) return;
            if (ppIsPlaying) {
                ppAudio.pause();
            } else {
                ppAudio.play();
            }
        }

        ppAudio.addEventListener('play', function() {
            ppIsPlaying = true;
            document.getElementById('ppPlayIcon').innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
        });
        ppAudio.addEventListener('pause', function() {
            ppIsPlaying = false;
            document.getElementById('ppPlayIcon').innerHTML = '<path d="M8 5v14l11-7z"/>';
        });
        ppAudio.addEventListener('timeupdate', function() {
            if (ppAudio.duration) {
                var pct = (ppAudio.currentTime / ppAudio.duration) * 100;
                document.getElementById('ppProgressFill').style.width = pct + '%';
                document.getElementById('ppCurrentTime').textContent = formatTime(ppAudio.currentTime);
                document.getElementById('ppDuration').textContent = formatTime(ppAudio.duration);
            }
        });
        ppAudio.addEventListener('ended', function() {
            if (ppRepeatOn) {
                ppAudio.currentTime = 0; ppAudio.play();
            } else {
                ppNext();
            }
        });

        // Click on progress bar to seek
        document.getElementById('ppProgressBar').addEventListener('click', function(e) {
            if (!ppAudio.duration) return;
            var rect = this.getBoundingClientRect();
            var pct = (e.clientX - rect.left) / rect.width;
            ppAudio.currentTime = pct * ppAudio.duration;
        });

        function ppNext() {
            if (ppTracks.length === 0) return;
            var next = ppShuffleOn ? Math.floor(Math.random() * ppTracks.length) : ppCurrentIndex + 1;
            if (next >= ppTracks.length) next = 0;
            loadPPTrack(next);
            ppAudio.play();
        }
        function ppPrev() {
            if (ppTracks.length === 0) return;
            if (ppAudio.currentTime > 3) { ppAudio.currentTime = 0; return; }
            var prev = ppCurrentIndex - 1;
            if (prev < 0) prev = ppTracks.length - 1;
            loadPPTrack(prev);
            ppAudio.play();
        }
        function ppShuffle() { ppShuffleOn = !ppShuffleOn; }
        function ppRepeat() { ppRepeatOn = !ppRepeatOn; }
        function ppSetVolume(val) { ppAudio.volume = val / 100; }

        function formatTime(s) {
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ':' + (sec < 10 ? '0' : '') + sec;
        }

        function renderQueue() {
            var el = document.getElementById('ppQueueList');
            if (ppTracks.length === 0) {
                el.innerHTML = '<p style="color:var(--text-secondary); font-size:0.85rem; padding:12px;">No tracks to show</p>';
                return;
            }
            el.innerHTML = '';
            ppTracks.forEach(function(track, i) {
                var div = document.createElement('div');
                div.className = 'pp-track' + (i === ppCurrentIndex ? ' active' : '');
                div.setAttribute('data-index', i);
                div.onclick = function() { loadPPTrack(i); ppAudio.play(); };
                var artHtml = track.artwork_url
                    ? '<img src="' + track.artwork_url + '">'
                    : '<svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
                div.innerHTML = '<div class="pp-track-num">' + (i + 1) + '</div>' +
                    '<div class="pp-track-art">' + artHtml + '</div>' +
                    '<div class="pp-track-info"><h4>' + track.title + '</h4><p>' + track.artist + '</p></div>';
                el.appendChild(div);
            });
        }

        function highlightQueueTrack(index) {
            document.querySelectorAll('.pp-track').forEach(function(t, i) {
                t.classList.toggle('active', i === index);
            });
        }

        (function() {
            var old = localStorage.getItem('theme');
            if (old && !localStorage.getItem('themePreference')) {
                localStorage.setItem('themePreference', old);
                localStorage.removeItem('theme');
            }
            var pref = localStorage.getItem('themePreference') || 'system';
            if (pref === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
            else if (pref === 'light') document.documentElement.setAttribute('data-theme', 'light');
            else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme', 'dark');
            else document.documentElement.setAttribute('data-theme', 'light');
        })();

        // Init
        loadCreatorProfile().then(function() { loadProfileTab(); });
        loadMyContent();
    </script>
</body>
</html>
